<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表盘 - 兼职项目管理系统</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            /* 主渐变色 */
            --gradient-1: linear-gradient(135deg, #13f1fc 0%, #0470dc 100%);
            --gradient-2: linear-gradient(135deg, #f6d242 0%, #ff52e5 100%);
            --gradient-3: linear-gradient(135deg, #69ff97 0%, #00e4ff 100%);
            --gradient-4: linear-gradient(135deg, #ff6b6b 0%, #556270 100%);
            --gradient-5: linear-gradient(135deg, #ffd34f 0%, #ff9b44 100%);
            --gradient-6: linear-gradient(135deg, #c56cd6 0%, #3425af 100%);
            --gradient-7: linear-gradient(135deg, #17ead9 0%, #6078ea 100%);
            --gradient-8: linear-gradient(135deg, #f02fc2 0%, #6094ea 100%);
            --gradient-9: linear-gradient(135deg, #08aeea 0%, #2af598 100%);
            --gradient-10: linear-gradient(135deg, #b721ff 0%, #21d4fd 100%);

            /* 纯色 */
            --primary: #0470dc;
            --secondary: #ff52e5;
            --success: #2af598;
            --info: #21d4fd;
            --warning: #ffd34f;
            --danger: #ff6b6b;
            --purple: #b721ff;
            --cyan: #13f1fc;
            --pink: #f02fc2;
            --orange: #ff9b44;
        }
        
        body {
            background: #f8f9fe;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-y: auto;
        }

        .navbar {
            background: var(--gradient-6);
            padding: 0.75rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .navbar .container {
            max-width: 95%;
            padding: 0 1rem;
        }

        .navbar-brand {
            font-weight: 600;
            color: white !important;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .main-container {
            max-width: 95%;
            margin: 1rem auto;
            padding: 1rem;
            min-height: calc(100vh - 70px); /* 减去导航栏高度 */
        }

        .stats-card {
            border: none;
            border-radius: 15px;
            padding: 1.25rem;
            height: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .row {
            margin-right: -0.5rem;
            margin-left: -0.5rem;
        }

        .col-md-3 {
            padding-right: 0.5rem;
            padding-left: 0.5rem;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.9;
            z-index: 0;
        }

        .stats-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            z-index: 1;
        }

        .stats-card-1::before { background: var(--gradient-1); }
.stats-card-2::before { background: var(--gradient-8); }
.stats-card-3::before { background: var(--gradient-9); }
.stats-card-4::before { background: var(--gradient-10); }
.stats-card-5::before { background: linear-gradient(135deg, #FF6B6B 0%, #FFD93D 100%); }

/* 价格隐藏样式 */
.price-value {
    transition: all 0.3s ease;
}

.price-hidden {
    color: #999;
    font-size: 1.2em;
    letter-spacing: 2px;
}

#togglePriceBtn {
    transition: all 0.3s ease;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    border: 1px solid rgba(255,255,255,0.5);
}

#togglePriceBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

#togglePriceBtn.btn-outline-light {
    color: white;
    border-color: rgba(255,255,255,0.5);
}

#togglePriceBtn.btn-outline-light:hover {
    background-color: rgba(255,255,255,0.1);
    border-color: white;
    color: white;
}

#togglePriceBtn.btn-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

#togglePriceBtn.btn-warning:hover {
    background-color: #ffca2c;
    border-color: #ffc720;
    color: #000;
}
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        }

        .stats-card * {
            position: relative;
            z-index: 2;
            color: white;
        }

        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stats-card p {
            font-size: 1.1rem;
            margin-bottom: 0;
            opacity: 0.9;
        }

        .stats-card i {
            position: absolute;
            right: 1.5rem;
            bottom: 1.5rem;
            font-size: 3rem;
            opacity: 0.2;
            transform: rotate(-15deg);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.05);
            background: white;
            margin-bottom: 1rem;
            overflow: visible !important;
        }

        .card-header {
            background: linear-gradient(to right, rgba(19, 241, 252, 0.1), rgba(4, 112, 220, 0.1));
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            overflow: visible !important;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-custom {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-custom::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            z-index: 1;
        }

        .btn-custom.btn-primary { background: var(--gradient-1); }
        .btn-custom.btn-info { background: var(--gradient-7); }
        .btn-custom.btn-danger { background: var(--gradient-4); }
        .btn-custom.btn-success { background: var(--gradient-9); }
        .btn-custom.btn-warning { background: var(--gradient-5); }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .table-responsive {
            margin: -1px;
        }

        .table {
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        /* 表头样式 */
        .table > thead > tr > th {
            padding: 1rem;
            white-space: nowrap;
            background-color: #7BB3E8;
            color: #2c3e50 !important;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            vertical-align: middle;
            text-shadow: none;
            pointer-events: none;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .table > thead > tr > th:hover {
            background-color: #6ba3d8;
            transition: background-color 0.3s ease;
        }

        .table > thead > tr > th:not(:last-child)::after,
        .table > tbody > tr > td:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 25%;
            height: 50%;
            width: 1px;
            background: rgba(52, 73, 94, 0.15);
        }

        .table > tbody > tr > td:not(:last-child)::after {
            background: rgba(0, 0, 0, 0.1);
        }

        .table > thead > tr > th,
        .table > tbody > tr > td {
            position: relative;
            padding: 1rem;
        }

        .table > thead > tr > th:first-child {
            border-top-left-radius: 8px;
        }
        
        .table > thead > tr > th:last-child {
            border-top-right-radius: 8px;
        }

        .table > tbody > tr > td {
            vertical-align: middle;
            text-align: center;
            background-color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 0;
            padding: 1rem 0.5rem;
            color: #34495e;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-weight: 500;
        }

        .table > tbody > tr:last-child {
            border-bottom: none;
        }

        .table > tbody > tr:hover > td {
            background-color: rgba(123, 179, 232, 0.08);
            color: #2c3e50;
        }

        .table > tbody > tr:last-child > td:first-child {
            border-bottom-left-radius: 8px;
        }
        
        .table > tbody > tr:last-child > td:last-child {
            border-bottom-right-radius: 8px;
        }
        
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
            min-width: 55px;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-badge::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            z-index: 1;
        }

        .status-badge[data-status="进行中"] {
            background: var(--gradient-3);
        }

        .status-badge[data-status="已完成"] {
            background: var(--gradient-1);
        }

        .status-badge[data-status="审核中"] {
            background: var(--gradient-5);
        }

        .status-badge[data-status="已暂停"] {
            background: var(--gradient-4);
        }

        .status-badge[data-status="已取消"] {
            background: var(--gradient-8);
        }

        /* 协作项目标识样式 */
        .collaboration-badge {
            margin-top: 0.25rem;
            padding: 0.2rem 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            animation: subtle-glow 2s ease-in-out infinite alternate;
        }

        .collaboration-badge i {
            font-size: 0.65rem;
        }

        @keyframes subtle-glow {
            0% { box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
            100% { box-shadow: 0 2px 12px rgba(102, 126, 234, 0.5); }
        }

        .icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .icon-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            z-index: 0;
        }

        .icon-circle i {
            position: relative;
            z-index: 1;
        }

        .icon-circle.primary::before { background: var(--gradient-1); }
        .icon-circle.info::before { background: var(--gradient-7); }
        .icon-circle.success::before { background: var(--gradient-9); }
        .icon-circle.warning::before { background: var(--gradient-5); }

        .icon-circle.primary i { color: var(--primary); }
        .icon-circle.info i { color: var(--info); }
        .icon-circle.success i { color: var(--success); }
        .icon-circle.warning i { color: var(--warning); }

        @media (max-width: 1400px) {
            .main-container {
                max-width: 98%;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                max-width: 100%;
                padding: 0.5rem;
            }

            .stats-card {
                margin-bottom: 0.5rem;
            }

            .card-header {
                padding: 0.75rem 1rem;
            }

            .table th,
            .table td {
                padding: 0.5rem 0.75rem;
            }
        }

        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .stats-card:hover i {
            animation: pulse 1s infinite;
        }

        /* 操作按钮容器居中 */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        /* 表格容器和响应式容器样式 */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            padding: 1px;
            position: relative;
            margin-bottom: 2rem;
            overflow: visible !important;
        }

        .table-responsive {
            overflow: visible !important;
        }

        .table {
            margin-bottom: 0;
        }

        /* 下拉菜单相关样式 */
        .dropdown {
            position: relative;
        }

        .action-cell {
            position: relative;
            padding-right: 1rem !important;
            width: 60px;
        }

        .dropdown-menu {
            padding: 0.4rem 0;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            z-index: 9999;
            min-width: 110px;
            width: fit-content;
            background: white;
            transform: none !important;
        }

        .dropdown-menu.show {
            position: fixed !important;
            margin-left: 23px !important;
        }

        /* 确保所有父容器都不限制溢出 */
        .main-container,
        .container,
        .row,
        .col,
        .card,
        .card-body,
        .table-responsive,
        .table-container {
            overflow: visible !important;
        }

        /* 最后几行的下拉菜单向上展开 */
        tr:nth-last-child(-n+3) .dropdown-menu.show {
            bottom: 100%;
            margin-bottom: 5px;
        }

        /* 更多按钮样式 */
        .more-btn {
            background: none;
            border: none;
            color: #666;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            margin-left: -8px;
        }

        .more-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }

        /* 查看按钮基础样式 */
        .view-btn {
            border: none;
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            min-width: 70px;
            color: white;
            background-size: 200% auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .view-btn:hover {
            background-position: right center;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* 总价行样式 */
        .components-total-row {
            background: linear-gradient(135deg, rgba(19, 241, 252, 0.1) 0%, rgba(4, 112, 220, 0.1) 100%);
            border-top: 2px solid rgba(4, 112, 220, 0.3);
        }

        .components-total-row td {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .components-total-price {
            color: var(--primary) !important;
            font-size: 1.2rem !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 查看元件按钮 */
        .view-btn.components {
            background-image: linear-gradient(45deg, #00BCD4, #2196F3, #00BCD4);
        }

        /* 查看要求按钮 */
        .view-btn.requirements {
            background-image: linear-gradient(45deg, #4CAF50, #8BC34A, #4CAF50);
        }

        /* 下拉菜单项基础样式 */
        .dropdown-item {
            padding: 0.6rem 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 0.1rem 0.3rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        /* 编辑按钮 */
        .dropdown-item.edit {
            color: #2196F3;
        }
        .dropdown-item.edit i {
            color: #2196F3;
        }
        .dropdown-item.edit:hover {
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05));
        }
        .dropdown-item.edit:hover i {
            transform: rotate(15deg);
        }

        /* 上传按钮 */
        .dropdown-item.upload {
            color: #4CAF50;
        }
        .dropdown-item.upload i {
            color: #4CAF50;
        }
        .dropdown-item.upload:hover {
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
        }
        .dropdown-item.upload:hover i {
            transform: translateY(-2px);
        }

        /* 下载按钮 */
        .dropdown-item.download {
            color: #00BCD4;
        }
        .dropdown-item.download i {
            color: #00BCD4;
        }
        .dropdown-item.download:hover {
            background: linear-gradient(45deg, rgba(0, 188, 212, 0.1), rgba(0, 188, 212, 0.05));
        }
        .dropdown-item.download:hover i {
            transform: translateY(2px);
        }

        /* 分享按钮 */
        .dropdown-item.share {
            color: #9C27B0;
        }
        .dropdown-item.share i {
            color: #9C27B0;
        }
        .dropdown-item.share:hover {
            background: linear-gradient(45deg, rgba(156, 39, 176, 0.1), rgba(156, 39, 176, 0.05));
        }
        .dropdown-item.share:hover i {
            transform: rotate(-15deg);
        }

        /* 共享按钮 */
        .dropdown-item.collaborate {
            color: #FF9800;
        }
        .dropdown-item.collaborate i {
            color: #FF9800;
        }
        .dropdown-item.collaborate:hover {
            background: linear-gradient(45deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05));
        }
        .dropdown-item.collaborate:hover i {
            transform: scale(1.1);
        }

        /* 删除按钮 */
        .dropdown-item.delete {
            color: #F44336;
        }
        .dropdown-item.delete i {
            color: #F44336;
        }
        .dropdown-item.delete:hover {
            background: linear-gradient(45deg, rgba(244, 67, 54, 0.1), rgba(244, 67, 54, 0.05));
        }
        .dropdown-item.delete:hover i {
            transform: scale(1.1);
        }

        /* 退出协作按钮 */
        .dropdown-item.leave-collaboration {
            color: #FF5722;
        }
        .dropdown-item.leave-collaboration i {
            color: #FF5722;
        }
        .dropdown-item.leave-collaboration:hover {
            background: linear-gradient(45deg, rgba(255, 87, 34, 0.1), rgba(255, 87, 34, 0.05));
        }
        .dropdown-item.leave-collaboration:hover i {
            transform: translateX(-2px);
        }

        /* 图标和文字通用样式 */
        .dropdown-item i {
            width: 16px;
            text-align: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .dropdown-item span {
            position: relative;
            z-index: 1;
            font-weight: 500;
        }

        /* 悬停效果 */
        .dropdown-item:hover {
            transform: translateX(3px);
        }

        /* 表头最后一列样式 */
        .table > thead > tr > th:last-child {
            width: 60px;
            padding-right: 1rem !important;
        }

        /* 表格列宽样式 */
        .table th.col-index,
        .table td.col-index {
            width: 50px;
            min-width: 50px;
        }

        .table th.col-source,
        .table td.col-source {
            width: 80px;
            min-width: 80px;
        }
        
        .table th.col-name,
        .table td.col-name {
            width: 140px;
            min-width: 140px;
            text-align: center;
        }

        .table td.col-name .d-flex {
            justify-content: center;
        }

        .table td.col-name .collaboration-badge {
            text-align: center;
            margin-top: 0.25rem;
        }

        .table th.col-price,
        .table td.col-price {
            width: 80px;
            min-width: 80px;
        }

        .table th.col-type,
        .table td.col-type {
            width: 100px;
            min-width: 100px;
        }

        .table th.col-status,
        .table td.col-status {
            width: 60px;
            min-width: 60px;
        }

        .table th.col-remark,
        .table td.col-remark {
            width: 230px;
            min-width: 230px;
            text-align: center;
        }

        .table th.col-components,
        .table td.col-components {
            width: 60px;
            min-width: 60px;
        }

        .table th.col-requirements,
        .table td.col-requirements {
            width: 60px;
            min-width: 60px;
        }

        .table th.col-actions,
        .table td.col-actions {
            width: 60px;
            min-width: 60px;
        }
        
        /* 备注文字样式 */
        .remark-text {
            text-align: left;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            padding: 0;
            color: #5a6c7d;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-weight: 400;
        }

        /* 共享状态图标样式 */
        .share-icon-owner {
            color: #00BCD4;
        }

        .share-icon-collaborator {
            color: #FF9800;
        }

        /* 共享状态图标样式 */
        .share-icon-owner {
            color: #00BCD4;
            font-size: 0.8rem;
            margin-left: 0.2rem;
        }

        .share-icon-collaborator {
            color: #FF9800;
            font-size: 0.8rem;
            margin-left: 0.2rem;
        }

        /* 确保按钮和状态标签不受省略影响 */
        .table > tbody > tr > td:has(.view-btn),
        .table > tbody > tr > td:has(.status-badge),
        .table > tbody > tr > td:has(.more-btn) {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            max-width: none;
        }

        /* 状态标签容器不需要省略 */
        .table > tbody > tr > td:has(.status-badge) {
            padding: 1rem;
        }

        /* 操作按钮容器不需要省略 */
        .table > tbody > tr > td.col-actions {
            padding: 1rem;
            white-space: normal;
            overflow: visible;
            max-width: none;
        }

        .components-selector {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .components-list-container {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .components-list {
            height: 100%;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
        }

        /* 自定义滚动条样式 */
        .components-list::-webkit-scrollbar {
            width: 6px;
        }

        .components-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .components-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .components-list::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .component-item {
            background: white;
            padding: 0.4rem 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 0.35rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
            min-height: 44px;
            font-size: 0.85rem;
        }

        .component-item:hover {
            border-color: #4a90e2;
            box-shadow: 0 1px 4px rgba(74, 144, 226, 0.1);
            transform: translateY(-1px);
        }

        .component-info {
            flex-grow: 1;
            margin-right: 0.5rem;
            display: flex;
            align-items: center;
        }

        .component-info .form-check {
            margin: 0;
            padding-left: 1.5rem;
        }

        .component-info .form-check-input {
            margin-top: 0;
            /* margin-left: -1.5rem; */
            width: 1rem;
            height: 1rem;
        }

        .component-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 0;
            font-size: 0.875rem;
            line-height: 1.2;
        }

        .component-model {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.1rem;
        }

        .component-price {
            color: #2196F3;
            font-weight: 500;
            white-space: nowrap;
            margin: 0 0.35rem;
            font-size: 0.875rem;
        }

        .quantity-input {
            width: 65px;
            display: none;
        }

        .quantity-input .form-control {
            border-radius: 4px;
            text-align: center;
            padding: 0.25rem;
            height: calc(1.5rem + 2px);
            font-size: 0.875rem;
            -moz-appearance: textfield;
        }

        .quantity-input .form-control::-webkit-outer-spin-button,
        .quantity-input .form-control::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-input .input-group {
            position: relative;
        }

        .quantity-input .input-group-buttons {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 16px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #dee2e6;
        }

        .quantity-input .input-group-buttons button {
            padding: 0;
            border: none;
            background: none;
            height: 50%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quantity-input .input-group-buttons button:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: #495057;
        }

        .quantity-input .input-group-buttons button:active {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .quantity-input .input-group-buttons button:first-child {
            border-bottom: 1px solid #dee2e6;
        }

        .selected-count {
            color: #666;
            font-size: 0.9rem;
            padding: 0.5rem 0;
        }

        /* 表单验证样式 */
        .was-validated .form-control:invalid:focus,
        .was-validated .form-select:invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }

        .was-validated .form-control:valid:focus,
        .was-validated .form-select:valid:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
        }

        /* 要求项样式 */
        .requirement-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .requirement-item .requirement-title {
            font-weight: 600;
            color: #2196F3;
            margin-bottom: 0.5rem;
        }

        .requirement-item .requirement-content {
            color: #666;
            margin-bottom: 0;
        }

        .requirement-item .remove-requirement {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: #dc3545;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .requirement-item .remove-requirement:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .requirements-container {
            background: #f8f9fa;
        }

        #requirementsList {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .requirement-item {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 模态框滚动样式 */
        .modal-dialog {
            max-height: 90vh;
            margin: 1.75rem auto;
        }

        .modal-content {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-height: calc(90vh - 3.5rem);
            display: flex;
            flex-direction: column;
        }

        .modal-body {
            overflow-y: auto;
            max-height: calc(90vh - 12rem);
        }

        .modal-header {
            background: linear-gradient(135deg, #6078ea 0%, #17ead9 100%);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            border: none;
            padding: 1.5rem;
        }

        .modal-title {
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .modal-header .btn-close {
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            padding: 0.5rem;
            margin: -0.5rem -0.5rem -0.5rem auto;
        }

        .modal-header .btn-close:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .modal-body {
            padding: 2rem;
            background: #fff;
        }

        .modal-footer {
            background: #f8f9fa;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            padding: 1rem 2rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* 表单组样式 */
        .form-group {
            margin-bottom: 1.5rem;
        }

        /* 标签样式 */
        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        /* 输入框和下拉框基础样式 */
        .form-control,
        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
            color: #2c3e50;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #6078ea;
            background-color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(96, 120, 234, 0.15);
        }

        /* 下拉框特殊样式 */
        .form-select {
            background-image: linear-gradient(45deg, transparent 50%, #6078ea 50%),
                              linear-gradient(135deg, #6078ea 50%, transparent 50%);
            background-position: calc(100% - 20px) calc(1em + 2px),
                                 calc(100% - 15px) calc(1em + 2px);
            background-size: 5px 5px,
                            5px 5px;
            background-repeat: no-repeat;
            padding-right: 2.5rem;
        }

        .form-select:focus {
            background-image: linear-gradient(45deg, #6078ea 50%, transparent 50%),
                              linear-gradient(135deg, transparent 50%, #6078ea 50%);
        }

        /* 输入组样式 */
        .input-group {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .input-group-text {
            background: #f0f3f8;
            border: 2px solid #e9ecef;
            border-right: none;
            color: #6078ea;
            font-weight: 600;
            padding: 0.75rem 1rem;
        }

        .input-group .form-control {
            border-left: none;
        }

        .input-group:focus-within .input-group-text {
            border-color: #6078ea;
            background-color: #f8f9fa;
        }

        /* 文本框样式 */
        textarea.form-control {
            min-height: 120px;
            line-height: 1.6;
        }

        /* 复选框样式 */
        .form-check-input {
            width: 1.2rem;
            height: 1.2rem;
            margin-top: 0.2rem;
            margin-right: 0.5rem;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .form-check-input:checked {
            background-color: #6078ea;
            border-color: #6078ea;
        }

        .form-check-input:focus {
            border-color: #6078ea;
            box-shadow: 0 0 0 0.2rem rgba(96, 120, 234, 0.15);
        }

        /* 数字输入框样式 */
        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 验证状态样式 */
        .was-validated .form-control:valid,
        .was-validated .form-select:valid {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        .was-validated .form-control:invalid,
        .was-validated .form-select:invalid {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        .was-validated .form-control:valid:focus,
        .was-validated .form-select:valid:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.15);
        }

        .was-validated .form-control:invalid:focus,
        .was-validated .form-select:invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
        }

        /* 帮助文本样式 */
        .form-text {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* 必填字段标记 */
        .required-field::after {
            content: '*';
            color: #dc3545;
            margin-left: 4px;
        }

        /* 元器件选择区域样式增强 */
        .components-selector {
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.02);
        }

        .components-list-container {
            margin-top: 1rem;
            max-height: 60vh;
            overflow: hidden;
        }

        .components-list {
            height: 100%;
            overflow-y: auto;
            padding-right: 0.5rem;
            margin-right: -0.5rem;
        }

        .components-list .row {
            margin-right: -0.35rem;
            margin-left: -0.35rem;
        }

        .components-list .col-md-4 {
            padding-right: 0.35rem;
            padding-left: 0.35rem;
        }

        /* 自定义滚动条样式 */
        .components-list::-webkit-scrollbar {
            width: 6px;
        }

        .components-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .components-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .components-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .selected-count {
            background: rgba(96, 120, 234, 0.1);
            color: #6078ea;
            padding: 0.35rem 0.75rem;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* 搜索框样式增强 */
        .search-box .form-control {
            background: #ffffff;
            border: 1px solid #e9ecef;
            padding: 0.5rem 0.75rem;
            height: calc(2rem + 2px);
            font-size: 0.875rem;
            border-radius: 6px;
        }
        
        .search-box .form-control:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.15);
        }

        /* 项目搜索框特殊样式 */
        #projectSearchInput {
            min-width: 250px;
            height: calc(2.25rem + 2px);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }

        #projectSearchInput:focus {
            border-color: #6078ea;
            background-color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(96, 120, 234, 0.15);
        }

        /* 表格行隐藏样式 */
        .table tbody tr.hidden {
            display: none;
        }

        /* 无结果提示样式 */
        .no-results {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            font-style: italic;
        }

        /* 要求文本框样式增强 */
        textarea[name="requirements"] {
            font-family: 'Consolas', monospace;
            line-height: 1.6;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            font-size: 0.875rem;
            padding: 0.75rem;
        }

        textarea[name="requirements"]:focus {
            background: #fff;
        }

        /* 提示文本样式增强 */
        .text-muted {
            color: #6c757d !important;
            font-size: 0.875rem;
            font-style: italic;
        }

        .text-muted1 {
            color: #2c3e50 !important;
            font-size: 0.875rem;
            font-style: italic;
        }
        /* 模态框按钮样式 */
        .modal-footer .btn {
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
        }
        
        .modal-footer .btn-secondary {
            background: #f0f3f8;
            color: #6c757d;
            box-shadow: 0 2px 6px rgba(108, 117, 125, 0.15);
        }

        .modal-footer .btn-secondary:hover {
            background: #e9ecef;
            color: #495057;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.2);
        }

        .modal-footer .btn-primary {
            background: linear-gradient(135deg, #6078ea 0%, #17ead9 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(96, 120, 234, 0.2);
        }

        .modal-footer .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(96, 120, 234, 0.3);
        }

        .modal-footer .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(96, 120, 234, 0.2);
        }

        /* Toast 通知样式 */
        .toast-container {
            z-index: 1060;
        }

        .toast {
            background: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            min-width: 300px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        
        .toast.show {
            opacity: 1;
        }

        .toast-header {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            border: none;
            padding: 0.75rem 1rem;
            color: white;
            font-weight: 600;
        }

        /* 成功提示样式 */
        .toast-header[data-type="创建成功"],
        .toast-header[data-type="修改成功"],
        .toast-header[data-type="删除成功"] {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        /* 错误提示样式 */
        .toast-header[data-type="创建失败"],
        .toast-header[data-type="修改失败"],
        .toast-header[data-type="删除失败"] {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }

        .toast-header .btn-close {
            background-color: rgba(255, 255, 255, 0.5);
            padding: 0.5rem;
            margin-right: -0.5rem;
            margin-top: -0.5rem;
            margin-bottom: -0.5rem;
            transition: background-color 0.2s;
        }

        .toast-header .btn-close:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .toast-body {
            padding: 1rem;
            color: #2c3e50;
            font-weight: 500;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* 状态样式 */
        #status-styles {
            display: none;
        }

        /* 文件树样式 */
        .file-tree {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-size: 0.9rem;
        }

        .file-tree-item {
            padding: 4px 0;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .file-tree-item:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .file-tree-item-content {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
        }

        .file-tree-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
            color: #6c757d;
        }

        .file-tree-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: #495057;
        }

        .file-tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .file-tree-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 14px;
        }

        .file-tree-icon.folder {
            color: #ffc107;
        }

        .file-tree-icon.file {
            color: #6c757d;
        }

        .file-tree-icon.file.pdf { color: #dc3545; }
        .file-tree-icon.file.doc,
        .file-tree-icon.file.docx { color: #007bff; }
        .file-tree-icon.file.jpg,
        .file-tree-icon.file.jpeg,
        .file-tree-icon.file.png,
        .file-tree-icon.file.gif { color: #28a745; }
        .file-tree-icon.file.txt { color: #6c757d; }
        .file-tree-icon.file.zip,
        .file-tree-icon.file.rar { color: #fd7e14; }

        .file-tree-name {
            flex-grow: 1;
            margin-right: 10px;
            word-break: break-word;
        }

        .file-tree-size {
            font-size: 0.8rem;
            color: #6c757d;
            margin-right: 10px;
            white-space: nowrap;
        }

        .file-tree-checkbox {
            margin-left: auto;
        }

        .file-tree-children {
            margin-left: 26px;
            border-left: 1px dashed #dee2e6;
            padding-left: 10px;
            display: none;
        }

        .file-tree-children.expanded {
            display: block;
        }

        .file-tree-item.folder > .file-tree-item-content {
            font-weight: 500;
        }

        .file-tree-item.file .file-tree-toggle {
            visibility: hidden;
        }

        .file-tree-empty {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            font-style: italic;
        }

        .file-tree-loading {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        /* 文件计数样式 */
        .file-count-badge {
            background-color: #e9ecef;
            color: #495057;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        /* 模态框动画效果 */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes modalBounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes modalShakeIn {
            0% {
                opacity: 0;
                transform: scale(0.8) rotate(-5deg);
            }
            25% {
                transform: scale(0.9) rotate(2deg);
            }
            50% {
                transform: scale(1.05) rotate(-1deg);
            }
            75% {
                transform: scale(0.95) rotate(1deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes modalZoomIn {
            from {
                opacity: 0;
                transform: scale(0.5) rotateY(90deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }

        @keyframes modalFlipIn {
            from {
                opacity: 0;
                transform: rotateX(-90deg) scale(0.8);
            }
            to {
                opacity: 1;
                transform: rotateX(0deg) scale(1);
            }
        }

        /* 模态框背景动画 */
        @keyframes backdropFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 0.5;
            }
        }

        /* 应用动画到模态框 */
        .modal {
            perspective: 1000px;
        }

        .modal.fade .modal-dialog {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal.show .modal-backdrop {
            animation: backdropFadeIn 0.3s ease-out;
        }

        /* 查看类模态框 - 从下方滑入 */
        #componentsModal.show .modal-dialog,
        #requirementsModal.show .modal-dialog {
            animation: modalSlideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* 编辑类模态框 - 弹性缩放 */
        #addProjectModal.show .modal-dialog,
        #editProjectModal.show .modal-dialog {
            animation: modalBounceIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* 功能类模态框 - 从右侧滑入 */
        #uploadModal.show .modal-dialog,
        #downloadModal.show .modal-dialog,
        #shareModal.show .modal-dialog {
            animation: modalSlideRight 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* 确认删除模态框 - 震动效果 */
        #deleteConfirmModal.show .modal-dialog,
        #confirmModal.show .modal-dialog {
            animation: modalShakeIn 0.6s ease-out;
        }

        /* 特殊动画 - 3D翻转效果（可选用于重要操作） */
        .modal-3d.show .modal-dialog {
            animation: modalFlipIn 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* 悬停效果增强 */
        .modal-dialog:hover {
            transform: scale(1.02) !important;
            transition: transform 0.2s ease;
        }

        /* 模态框内容动画延迟 */
        .modal.show .modal-header {
            animation: modalFadeIn 0.6s ease-out 0.1s both;
        }

        .modal.show .modal-body {
            animation: modalFadeIn 0.6s ease-out 0.2s both;
        }

        .modal.show .modal-footer {
            animation: modalFadeIn 0.6s ease-out 0.3s both;
        }

        /* 关闭动画 */
        .modal.fade:not(.show) .modal-dialog {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease-out;
        }

        /* 响应式动画优化 */
        @media (prefers-reduced-motion: reduce) {
            .modal.fade .modal-dialog,
            .modal.show .modal-dialog,
            .modal-dialog:hover {
                animation: none !important;
                transform: none !important;
                transition: none !important;
            }
        }

        /* 为小屏幕设备优化动画 */
        @media (max-width: 768px) {
            .modal.show .modal-dialog {
                animation-duration: 0.3s !important;
            }
            
            .modal-dialog:hover {
                transform: none !important;
            }
        }

        /* 模态框动画增强功能 */
        function enhanceModalAnimations() {
            // 为所有模态框添加动画增强
            document.querySelectorAll('.modal').forEach(modal => {
                // 监听模态框显示事件
                modal.addEventListener('show.bs.modal', function() {
                    // 为模态框内容添加渐进显示效果
                    const header = this.querySelector('.modal-header');
                    const body = this.querySelector('.modal-body');
                    const footer = this.querySelector('.modal-footer');
                    
                    // 重置动画状态
                    [header, body, footer].forEach(element => {
                        if (element) {
                            element.style.opacity = '0';
                            element.style.transform = 'translateY(20px)';
                        }
                    });
                });

                // 监听模态框显示完成事件
                modal.addEventListener('shown.bs.modal', function() {
                    // 逐步显示模态框内容
                    const header = this.querySelector('.modal-header');
                    const body = this.querySelector('.modal-body');
                    const footer = this.querySelector('.modal-footer');
                    
                    const animateElement = (element, delay = 0) => {
                        if (element) {
                            setTimeout(() => {
                                element.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                element.style.opacity = '1';
                                element.style.transform = 'translateY(0)';
                            }, delay);
                        }
                    };

                    animateElement(header, 100);
                    animateElement(body, 200);
                    animateElement(footer, 300);
                });

                // 监听模态框隐藏事件
                modal.addEventListener('hide.bs.modal', function() {
                    // 添加关闭动画
                    const dialog = this.querySelector('.modal-dialog');
                    if (dialog) {
                        dialog.style.transition = 'all 0.3s ease-out';
                        dialog.style.transform = 'scale(0.9)';
                        dialog.style.opacity = '0.5';
                    }
                });
            });
        }

        // 特殊动画函数
        function showModalWithSpecialEffect(modalId, effect = '') {
            const modal = document.getElementById(modalId);
            if (modal) {
                // 添加特殊效果类
                if (effect) {
                    modal.classList.add(effect);
                }
                
                // 显示模态框
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                // 移除特殊效果类（避免影响下次显示）
                modal.addEventListener('hidden.bs.modal', function() {
                    if (effect) {
                        this.classList.remove(effect);
                    }
                }, { once: true });
            }
        }

        // 增强的成功提示动画
        function showSuccessModal(title, message) {
            // 创建成功提示模态框
            const successModal = document.createElement('div');
            successModal.className = 'modal fade';
            successModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="modal-body text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: white; animation: successPulse 2s infinite;"></i>
                            </div>
                            <h4 class="text-white mb-2">${title}</h4>
                            <p class="text-white mb-0">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(successModal);
            
            // 添加特殊动画
            const modal = new bootstrap.Modal(successModal);
            modal.show();
            
            // 自动关闭
            setTimeout(() => {
                modal.hide();
                setTimeout(() => {
                    document.body.removeChild(successModal);
                }, 300);
            }, 2000);
        }

        // 为删除确认添加特殊效果
        function showDeleteConfirmation(projectId) {
            // 设置要删除的项目ID
            document.getElementById('deleteProjectId').value = projectId;
            
            // 添加震动效果
            showModalWithSpecialEffect('deleteConfirmModal', 'modal-shake-intense');
        }

        // 添加震动效果样式
        const shakeStyles = `
            @keyframes modalShakeIntense {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) rotate(-1deg); }
                20%, 40%, 60%, 80% { transform: translateX(8px) rotate(1deg); }
            }
            
            .modal-shake-intense.show .modal-dialog {
                animation: modalShakeIntense 0.8s ease-out, modalFadeIn 0.6s ease-out;
            }
            
            @keyframes successPulse {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.1); opacity: 0.8; }
            }
        `;

        // 动态添加样式
        const styleSheet = document.createElement('style');
        styleSheet.textContent = shakeStyles;
        document.head.appendChild(styleSheet);

        // 页面加载完成后初始化动画
        document.addEventListener('DOMContentLoaded', function() {
            enhanceModalAnimations();
            
            // 为特殊操作添加动画效果
            console.log('模态框动画系统已初始化');
        });

        /* 额外的动画效果 */
        @keyframes modalShakeIntense {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) rotate(-1deg); }
            20%, 40%, 60%, 80% { transform: translateX(8px) rotate(1deg); }
        }
        
        .modal-shake-intense.show .modal-dialog {
            animation: modalShakeIntense 0.8s ease-out, modalFadeIn 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* 协作项目标识样式 */
        .collaboration-badge {
            margin-top: 0.25rem;
            padding: 0.2rem 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            animation: subtle-glow 2s ease-in-out infinite alternate;
        }

        .collaboration-badge i {
            font-size: 0.65rem;
        }

        @keyframes subtle-glow {
            0% { box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
            100% { box-shadow: 0 2px 12px rgba(102, 126, 234, 0.5); }
        }

        .icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .icon-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            z-index: 0;
        }

        .icon-circle i {
            position: relative;
            z-index: 1;
        }

        .icon-circle.primary::before { background: var(--gradient-1); }
        .icon-circle.info::before { background: var(--gradient-7); }
        .icon-circle.success::before { background: var(--gradient-9); }
        .icon-circle.warning::before { background: var(--gradient-5); }

        .icon-circle.primary i { color: var(--primary); }
        .icon-circle.info i { color: var(--info); }
        .icon-circle.success i { color: var(--success); }
        .icon-circle.warning i { color: var(--warning); }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
    <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-microchip me-2"></i>
                兼职项目管理系统
            </a>
            <div class="d-flex align-items-center">
                <!-- 价格控制按钮 -->
                <button id="togglePriceBtn" class="btn {% if user_settings.hide_prices %}btn-warning{% else %}btn-outline-light{% endif %} btn-sm me-3">
                    <i id="togglePriceIcon" class="fas {% if user_settings.hide_prices %}fa-eye-slash{% else %}fa-eye{% endif %}"></i>
                    <span id="togglePriceText">{% if user_settings.hide_prices %}显示价格{% else %}隐藏价格{% endif %}</span>
                </button>
                
                <span class="text-white me-3">
                    <i class="fas fa-user-circle me-1"></i>
                    {{ session.username if session.username else '未登录' }}
                </span>
                <a class="btn btn-custom btn-light" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>退出
                </a>
        </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="container main-container">
        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="stats-card stats-card-1">
                    <h3 id="total-projects">{{ stats.total_projects }}</h3>
                    <p>总项目数</p>
                    <i class="fas fa-project-diagram"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card stats-card-2">
                    <h3 id="total-price" class="price-value">
                        <span class="price-visible" {% if user_settings.hide_prices %}style="display: none;"{% endif %}>¥{{ "%.2f"|format(stats.total_price) }}</span>
                        <span class="price-hidden" {% if not user_settings.hide_prices %}style="display: none;"{% endif %}>****</span>
                    </h3>
                    <p>总价格</p>
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card stats-card-3">
                    <h3 id="incomplete-projects">{{ stats.incomplete_projects }}</h3>
                    <p>未完成项目</p>
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card stats-card-4">
                    <h3 id="incomplete-price" class="price-value">
                        <span class="price-visible" {% if user_settings.hide_prices %}style="display: none;"{% endif %}>¥{{ "%.2f"|format(stats.incomplete_price) }}</span>
                        <span class="price-hidden" {% if not user_settings.hide_prices %}style="display: none;"{% endif %}>****</span>
                    </h3>
                    <p>未完成项目总价格</p>
                    <i class="fas fa-exclamation-circle"></i>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card stats-card-5">
                    <h3 id="components-price" class="price-value">
                        <span class="price-visible" {% if user_settings.hide_prices %}style="display: none;"{% endif %}>¥{{ "%.2f"|format(stats.components_total_price) }}</span>
                        <span class="price-hidden" {% if not user_settings.hide_prices %}style="display: none;"{% endif %}>****</span>
                    </h3>
                    <p>元器件总价格</p>
                    <i class="fas fa-microchip"></i>
                </div>
            </div>
        </div>

        <!-- 项目列表卡片 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">项目列表</h5>
                <div class="d-flex align-items-center gap-3">
                    <!-- 项目搜索框 -->
                    <div class="search-box">
                        <input type="text" class="form-control" id="projectSearchInput" placeholder="搜索项目名称...">
                    </div>
                    <button class="btn btn-custom btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
                        <i class="fas fa-plus me-1"></i>新建项目
                    </button>
                </div>
            </div>
        <div class="table-container">
                <table class="table">
                <thead>
                    <tr>
                            <th class="col-index">序号</th>
                            <th class="col-source">来源</th>
                            <th class="col-name">名称</th>
                            <th class="col-price">价格</th>
                            <th class="col-type">类型</th>
                            <th class="col-status">状态</th>
                            <th class="col-remark">备注</th>
                            <th class="col-components">元件</th>
                            <th class="col-requirements">要求</th>
                            <th class="col-actions">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in jobs %}
                    <tr>
                            <td class="col-index">{{ loop.index }}</td>
                            <td class="col-source">{{ job.source }}</td>
                            <td class="col-name">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span>{{ job.name }}</span>
                                    {% if job.is_shared_by_me %}
                                        <i class="fas fa-share-alt ms-2 share-icon-owner" title="已共享给其他用户"></i>
                                    {% endif %}
                                    {% if job.is_shared_to_me %}
                                        <i class="fas fa-users ms-2 share-icon-collaborator" title="来自 {{ job.owner_username }} 的共享项目"></i>
                                    {% endif %}
                                </div>
                                {% if job.user_role and job.user_role != 'owner' %}
                                    <div class="collaboration-badge">
                                        <i class="fas fa-users"></i>
                                        <span>协作项目 - 所有者: {{ job.owner_username }}</span>
                                    </div>
                                {% endif %}
                            </td>
                            <td class="col-price">¥{{ job.price }}</td>
                            <td class="col-type">{{ job.board_type }}</td>
                            <td class="col-status">
                                <span class="status-badge" data-status="{{ job.status }}">
                                {{ job.status }}
                            </span>
                        </td>
                            <td class="col-remark">
                                <div class="remark-text text-center" title="{{ job.remark }}">
                                    {{ job.remark if job.remark else '-' }}
                                </div>
                            </td>
                            <td class="col-components">
                                <button class="view-btn components" onclick="viewComponents('{{ job.id }}')">
                                    查看元件
                                </button>
                            </td>
                            <td class="col-requirements">
                                <button class="view-btn requirements" onclick="viewRequirements('{{ job.id }}')">
                                    查看要求
                                </button>
                            </td>
                            <td class="col-actions">
                                <div class="dropdown">
                                    <button class="more-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% if not job.user_role or job.user_role == 'owner' %}
                                        <li><a class="dropdown-item edit" href="#" onclick="editProject('{{ job.id }}')">
                                            <i class="fas fa-edit"></i><span>修改</span>
                                        </a></li>
                                        {% endif %}
                                        {% if not job.user_role or job.user_role == 'owner' or job.user_role == 'write' %}
                                        <li><a class="dropdown-item upload" href="#" onclick="uploadFiles('{{ job.id }}')">
                                            <i class="fas fa-upload"></i><span>上传</span>
                                        </a></li>
                                        {% endif %}
                                        <li><a class="dropdown-item download" href="#" onclick="downloadFiles('{{ job.id }}')">
                                            <i class="fas fa-download"></i><span>下载</span>
                                        </a></li>
                                        {% if not job.user_role or job.user_role == 'owner' or job.user_role == 'read' or job.user_role == 'write' %}
                                        <li><a class="dropdown-item share" href="#" onclick="shareProject('{{ job.id }}')">
                                            <i class="fas fa-share-alt"></i><span>分享</span>
                                        </a></li>
                                        {% endif %}
                                        {% if not job.user_role or job.user_role == 'owner' %}
                                        <li><a class="dropdown-item collaborate" href="#" onclick="collaborateProject('{{ job.id }}')">
                                            <i class="fas fa-users"></i><span>共享</span>
                                        </a></li>
                                        <li><a class="dropdown-item delete" href="#" onclick="deleteProject('{{ job.id }}')">
                                            <i class="fas fa-trash-alt"></i><span>删除</span>
                                        </a></li>
                                        {% else %}
                                        <li><a class="dropdown-item leave-collaboration" href="#" onclick="leaveCollaboration('{{ job.id }}')">
                                            <i class="fas fa-sign-out-alt"></i><span>退出</span>
                                        </a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <!-- 新建项目模态框 -->
    <div class="modal fade" id="addProjectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProjectForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <!-- 来源下拉框 -->
                            <div class="col-md-6">
                                <label class="form-label">来源</label>
                                <select class="form-select" name="source" required>
                                    <option value="">请选择来源</option>
                                </select>
                                <div class="invalid-feedback">请选择项目来源</div>
                            </div>

                            <!-- 名称输入框 -->
                            <div class="col-md-6">
                                <label class="form-label">名称</label>
                                <input type="text" class="form-control" name="name" required>
                                <div class="invalid-feedback">请输入项目名称</div>
                            </div>

                            <!-- 价格输入框 -->
                            <div class="col-md-6">
                                <label class="form-label">价格</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" name="price" required min="0" step="0.01">
                                    <div class="invalid-feedback">请输入有效的价格</div>
                                </div>
                            </div>

                            <!-- 类型下拉框 -->
                            <div class="col-md-6">
                                <label class="form-label">类型</label>
                                <select class="form-select" name="board_type" required>
                                    <option value="">请选择类型</option>
                                </select>
                                <div class="invalid-feedback">请选择电路板类型</div>
                            </div>

                            <!-- 状态下拉框 -->
                            <div class="col-md-6">
                                <label class="form-label">状态</label>
                                <select class="form-select" name="status" required>
                                    <option value="">请选择状态</option>
                                    <option value="进行中">进行中</option>
                                    <option value="已完成">已完成</option>
                                    <option value="审核中">审核中</option>
                                    <option value="已暂停">已暂停</option>
                                    <option value="已取消">已取消</option>
                                </select>
                                <div class="invalid-feedback">请选择项目状态</div>
                            </div>

                            <!-- 要求输入区域 -->
                            <div class="col-12">
                                <label class="form-label">项目要求</label>
                                <textarea class="form-control" name="requirements" rows="4" 
                                    placeholder="输入项目要求（使用##包围标题，如：##尺寸要求## 长度不超过10cm）"></textarea>
                                <small class="text-muted">提示：使用##包围的文字将作为标题显示，例如：##尺寸要求## 长度不超过10cm</small>
                            </div>

                            <!-- 元器件选择区域 -->
                            <div class="col-12">
                                <label class="form-label">元器件选择</label>
                                <div class="components-selector">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="search-box flex-grow-1 me-3">
                                            <input type="text" class="form-control" id="componentSearch" placeholder="搜索元器件...">
                                        </div>
                                        <div class="selected-count">
                                            已选择: <span id="selectedComponentCount">0</span>
                                        </div>
                                    </div>
                                    <div class="components-list-container">
                                        <div class="components-list">
                                            <div class="row g-2">
                                                <!-- 元器件列表将通过 JavaScript 动态加载 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 备注输入框 -->
                            <div class="col-12">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" name="remark" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitProject">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改项目模态框 -->
    <div class="modal fade" id="editProjectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProjectForm" class="needs-validation" novalidate>
                        <input type="hidden" name="projectId" id="editProjectId">
                        <div class="row g-3">
                            <!-- 来源下拉框 -->
                            <div class="col-md-6">
                                <label class="form-label">来源</label>
                                <select class="form-select" name="source" required>
                                    <option value="">请选择来源</option>
                                </select>
                                <div class="invalid-feedback">请选择项目来源</div>
                            </div>

                            <!-- 名称输入框 -->
                            <div class="col-md-6">
                                <label class="form-label">名称</label>
                                <input type="text" class="form-control" name="name" required>
                                <div class="invalid-feedback">请输入项目名称</div>
                            </div>

                            <!-- 价格输入框 -->
                            <div class="col-md-6">
                                <label class="form-label">价格</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" name="price" required min="0" step="0.01">
                                    <div class="invalid-feedback">请输入有效的价格</div>
                                </div>
                            </div>

                            <!-- 类型下拉框 -->
                            <div class="col-md-6">
                                <label class="form-label">类型</label>
                                <select class="form-select" name="board_type" required>
                                    <option value="">请选择类型</option>
                                </select>
                                <div class="invalid-feedback">请选择电路板类型</div>
                            </div>

                            <!-- 状态下拉框 -->
                            <div class="col-md-6">
                                <label class="form-label">状态</label>
                                <select class="form-select" name="status" required>
                                    <option value="进行中">进行中</option>
                                    <option value="已完成">已完成</option>
                                    <option value="审核中">审核中</option>
                                    <option value="已暂停">已暂停</option>
                                    <option value="已取消">已取消</option>
                                </select>
                                <div class="invalid-feedback">请选择项目状态</div>
                            </div>

                            <!-- 要求输入区域 -->
                            <div class="col-12">
                                <label class="form-label">项目要求</label>
                                <textarea class="form-control" name="requirements" rows="4" 
                                    placeholder="输入项目要求（使用##包围标题，如：##尺寸要求## 长度不超过10cm）"></textarea>
                                <small class="text-muted">提示：使用##包围的文字将作为标题显示，例如：##尺寸要求## 长度不超过10cm</small>
                            </div>

                            <!-- 元器件选择区域 -->
                            <div class="col-12">
                                <label class="form-label">元器件选择</label>
                                <div class="components-selector">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="search-box flex-grow-1 me-3">
                                            <input type="text" class="form-control" id="editComponentSearch" placeholder="搜索元器件...">
                                        </div>
                                        <div class="selected-count">
                                            已选择: <span id="editSelectedComponentCount">0</span>
                                        </div>
                                    </div>
                                    <div class="components-list-container">
                                        <div class="components-list" id="editComponentsList">
                                            <!-- 元器件列表将通过 JavaScript 动态加载 -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 备注输入框 -->
                            <div class="col-12">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" name="remark" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="updateProject">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除这个项目吗？此操作不可恢复。</p>
                    <input type="hidden" id="deleteProjectId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS 和依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    
    <!-- 协作功能 JavaScript -->
    <script src="{{ url_for('static', filename='js/collaboration.js') }}"></script>
    
    <!-- 自定义 JavaScript -->
    <script>
        // Session过期检查
        function checkSessionExpiry() {
            fetch('/api/session/status')
                .then(response => {
                    if (response.status === 401) {
                        // Session已过期，显示提示并跳转到登录页面
                        alert('登录已过期，请重新登录');
                        window.location.href = '/';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.remaining_time_seconds <= 60) {
                        // 剩余时间少于1分钟时提醒用户
                        const minutes = Math.floor(data.remaining_time_seconds / 60);
                        const seconds = data.remaining_time_seconds % 60;
                        console.log(`Session将在${minutes}分${seconds}秒后过期`);
                        
                        if (data.remaining_time_seconds <= 30) {
                            // 剩余30秒时显示警告
                            if (confirm('您的登录即将过期，是否要延长会话时间？')) {
                                // 发送一个请求来刷新session（通过访问任意需要认证的API）
                                fetch('/api/user/stats')
                                    .then(response => response.json())
                                    .then(() => {
                                        console.log('Session已刷新');
                                    })
                                    .catch(error => {
                                        console.error('刷新session失败:', error);
                                    });
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('检查session状态失败:', error);
                });
        }

        // 页面加载时检查session状态
        document.addEventListener('DOMContentLoaded', function() {
            // 立即检查一次
            checkSessionExpiry();
            
            // 每30秒检查一次session状态
            setInterval(checkSessionExpiry, 30000);
        });

        // 在所有AJAX请求中添加全局错误处理
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args)
                .then(response => {
                    if (response.status === 401) {
                        // 如果返回401，可能是session过期
                        alert('登录已过期，请重新登录');
                        window.location.href = '/';
                        return Promise.reject('Session expired');
                    }
                    return response;
                })
                .catch(error => {
                    throw error;
                });
        };

        // 模态框动画增强功能
        function enhanceModalAnimations() {
            // 为所有模态框添加动画增强
            document.querySelectorAll('.modal').forEach(modal => {
                // 监听模态框显示事件
                modal.addEventListener('show.bs.modal', function() {
                    // 为模态框内容添加渐进显示效果
                    const header = this.querySelector('.modal-header');
                    const body = this.querySelector('.modal-body');
                    const footer = this.querySelector('.modal-footer');
                    
                    // 重置动画状态
                    [header, body, footer].forEach(element => {
                        if (element) {
                            element.style.opacity = '0';
                            element.style.transform = 'translateY(20px)';
                        }
                    });
                });

                // 监听模态框显示完成事件
                modal.addEventListener('shown.bs.modal', function() {
                    // 逐步显示模态框内容
                    const header = this.querySelector('.modal-header');
                    const body = this.querySelector('.modal-body');
                    const footer = this.querySelector('.modal-footer');
                    
                    const animateElement = (element, delay = 0) => {
                        if (element) {
                            setTimeout(() => {
                                element.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                element.style.opacity = '1';
                                element.style.transform = 'translateY(0)';
                            }, delay);
                        }
                    };

                    animateElement(header, 100);
                    animateElement(body, 200);
                    animateElement(footer, 300);
                });

                // 监听模态框隐藏事件
                modal.addEventListener('hide.bs.modal', function() {
                    // 添加关闭动画
                    const dialog = this.querySelector('.modal-dialog');
                    if (dialog) {
                        dialog.style.transition = 'all 0.3s ease-out';
                        dialog.style.transform = 'scale(0.9)';
                        dialog.style.opacity = '0.5';
                    }
                });
            });
        }

        // 特殊动画函数
        function showModalWithSpecialEffect(modalId, effect = '') {
            const modal = document.getElementById(modalId);
            if (modal) {
                // 添加特殊效果类
                if (effect) {
                    modal.classList.add(effect);
                }
                
                // 显示模态框
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                // 移除特殊效果类（避免影响下次显示）
                modal.addEventListener('hidden.bs.modal', function() {
                    if (effect) {
                        this.classList.remove(effect);
                    }
                }, { once: true });
            }
        }

        // 增强的成功提示动画
        function showSuccessModal(title, message) {
            // 创建成功提示模态框
            const successModal = document.createElement('div');
            successModal.className = 'modal fade';
            successModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="modal-body text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: white; animation: successPulse 2s infinite;"></i>
                            </div>
                            <h4 class="text-white mb-2">${title}</h4>
                            <p class="text-white mb-0">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(successModal);
            
            // 添加特殊动画
            const modal = new bootstrap.Modal(successModal);
            modal.show();
            
            // 自动关闭
            setTimeout(() => {
                modal.hide();
                setTimeout(() => {
                    document.body.removeChild(successModal);
                }, 300);
            }, 2000);
        }

        // 为删除确认添加特殊效果
        function showDeleteConfirmation(projectId) {
            // 设置要删除的项目ID
            document.getElementById('deleteProjectId').value = projectId;
            
            // 添加震动效果
            showModalWithSpecialEffect('deleteConfirmModal', 'modal-shake-intense');
        }

        function viewDetails(jobId) {
            // TODO: 实现查看详情功能
            alert('查看详情功能开发中...');
        }

        function deleteProject(jobId) {
            if (confirm('确定要删除这个项目吗？')) {
                fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('删除失败：' + data.error);
                    } else {
                        alert('项目删除成功！');
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试');
                });
            }
        }

        // 查看元件详情
        function viewComponents(jobId) {
            fetch(`/api/job/components/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('componentsTableBody');
                    tbody.innerHTML = '';
                    
                    let totalPrice = 0;
                    data.components.forEach((component, index) => {
                        const itemTotal = component.price * component.quantity;
                        totalPrice += itemTotal;
                        
                        const row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${component.name}</td>
                                <td>${component.model}</td>
                                <td>¥${component.price.toFixed(2)}</td>
                                <td>${component.quantity}</td>
                                <td>¥${itemTotal.toFixed(2)}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // 更新总价显示
                    document.getElementById('totalComponentsPrice').textContent = '¥' + totalPrice.toFixed(2);
                    
                    new bootstrap.Modal(document.getElementById('componentsModal')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取元件信息失败');
                });
        }

        // 查看要求详情
        function viewRequirements(jobId) {
            fetch(`/api/job/requirements/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('requirementsList');
                    list.innerHTML = '';
                    
                    data.forEach((requirement, index) => {
                        const item = `
                            <div class="list-group-item">
                                <h6 class="mb-1" style="color: ${requirement.color}">${requirement.title}</h6>
                                <p class="mb-0">${requirement.content}</p>
                            </div>
                        `;
                        list.innerHTML += item;
                    });
                    
                    new bootstrap.Modal(document.getElementById('requirementsModal')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取要求信息失败');
                });
        }

        // 编辑项目
        function editProject(jobId) {
            // 获取项目数据
            fetch(`/api/jobs/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    const form = document.getElementById('editProjectForm');
                    
                    // 设置项目ID
                    document.getElementById('editProjectId').value = jobId;

                    // 先加载来源和类型选项，然后设置表单数据
                    Promise.all([
                        loadEditSourceOptions(data.source_id || data.source),
                        loadEditBoardTypes(data.board_type_id || data.board_type)
                    ]).then(() => {
                        // 填充表单数据
                        form.querySelector('[name="name"]').value = data.name;
                        form.querySelector('[name="price"]').value = data.price;
                        form.querySelector('[name="status"]').value = data.status;

                        // 处理项目要求
                        let requirementsText = '';
                        if (data.requirements && Array.isArray(data.requirements)) {
                            requirementsText = data.requirements.map(req => 
                                `##${req.title}## ${req.content}`
                            ).join('\n\n');
                        }
                        form.querySelector('[name="requirements"]').value = requirementsText;
                        
                        form.querySelector('[name="remark"]').value = data.remark || '';

                        // 加载并选中项目的元器件
                        loadEditComponents(data.components || []);

                        // 显示模态框
                        new bootstrap.Modal(document.getElementById('editProjectModal')).show();
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('错误', '加载项目数据失败');
                });
        }

        // 加载编辑模态框的来源选项
        function loadEditSourceOptions(selectedSource) {
            return fetch('/api/sources')
                .then(response => response.json())
                .then(sources => {
                    const sourceSelect = document.querySelector('#editProjectForm select[name="source"]');
                    if (!sourceSelect) {
                        throw new Error('Source select element not found');
                    }

                    // 保存默认选项
                    const defaultOption = sourceSelect.querySelector('option');
                    sourceSelect.innerHTML = '';
                    sourceSelect.appendChild(defaultOption);
                    
                    sources.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source.id;
                        option.textContent = source.name;
                        // 检查是否匹配ID或名称
                        if (source.id == selectedSource || source.name == selectedSource) {
                            option.selected = true;
                        }
                        sourceSelect.appendChild(option);
                    });
                });
        }

        // 加载编辑模态框的类型选项
        function loadEditBoardTypes(selectedType) {
            return fetch('/api/board-types')
                .then(response => response.json())
                .then(types => {
                    const typeSelect = document.querySelector('#editProjectForm select[name="board_type"]');
                    if (!typeSelect) {
                        throw new Error('Board type select element not found');
                    }

                    // 保存默认选项
                    const defaultOption = typeSelect.querySelector('option');
                    typeSelect.innerHTML = '';
                    typeSelect.appendChild(defaultOption);
                    
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.name;
                        // 检查是否匹配ID或名称
                        if (type.id == selectedType || type.name == selectedType) {
                            option.selected = true;
                        }
                        typeSelect.appendChild(option);
                    });
                });
        }

        // 加载编辑模态框的元器件
        function loadEditComponents(selectedComponents = []) {
            return fetch('/api/components')
                .then(response => response.json())
                .then(components => {
                    const componentsList = document.getElementById('editComponentsList');
                    if (!componentsList) {
                        throw new Error('Components list element not found');
                    }

                    componentsList.innerHTML = '<div class="row g-2">' + components.map(component => {
                        const isSelected = selectedComponents.some(sc => sc.id === component.id);
                        const quantity = isSelected ? 
                            selectedComponents.find(sc => sc.id === component.id).quantity : 1;
                        
                        return `
                            <div class="col-md-4">
                                <div class="component-item">
                                    <div class="form-check component-info">
                                        <input class="form-check-input component-checkbox" type="checkbox" 
                                               value="${component.id}" id="editComponent${component.id}"
                                               ${isSelected ? 'checked' : ''}>
                                        <label class="form-check-label" for="editComponent${component.id}">
                                            <div class="component-name">${component.name}</div>
                                            <div class="component-model">${component.model}</div>
                                        </label>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="component-price me-2">¥${component.price.toFixed(2)}</div>
                                        <div class="quantity-input" style="display: ${isSelected ? 'block' : 'none'};">
                                            <div class="input-group">
                                                <input type="number" class="form-control" min="1" value="${quantity}">
                                                <div class="input-group-buttons">
                                                    <button type="button" class="btn-up" onclick="adjustQuantity(this, 1)">
                                                        <i class="fas fa-caret-up"></i>
                                                    </button>
                                                    <button type="button" class="btn-down" onclick="adjustQuantity(this, -1)">
                                                        <i class="fas fa-caret-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') + '</div>';

                    // 添加复选框事件监听
                    document.querySelectorAll('#editComponentsList .component-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const quantityInput = this.closest('.component-item').querySelector('.quantity-input');
                            quantityInput.style.display = this.checked ? 'block' : 'none';
                            updateEditSelectedCount();
                        });
                    });

                    // 更新已选择数量
                    updateEditSelectedCount();

                    // 触发自定义事件，通知搜索功能组件已加载
                    const componentsLoadedEvent = new CustomEvent('componentsLoaded', { 
                        detail: { container: componentsList.querySelector('.row') } 
                    });
                    document.dispatchEvent(componentsLoadedEvent);
                })
                .catch(error => {
                    console.error('Error loading components:', error);
                    showToast('错误', '加载元器件列表失败');
                });
        }

        // 更新编辑模态框中已选择的元器件数量
        function updateEditSelectedCount() {
            const count = document.querySelectorAll('#editComponentsList .component-checkbox:checked').length;
            const countElement = document.getElementById('editSelectedComponentCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        let currentProjectId = null; // 添加全局变量

        function uploadFiles(jobId) {
            // 设置当前项目ID
            currentProjectId = jobId;
            
            // 显示上传模态框
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
        }

        function downloadFiles(jobId) {
            // 打开下载模态框
            const downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'));
            downloadModal.show();
            
            // 加载项目文件
            loadProjectFiles(jobId);
        }

        

        function collaborateProject(jobId) {
            // 打开项目协作管理模态框
            currentProjectId = jobId;
            
            // 获取项目信息并更新模态框标题
            const projectRow = document.querySelector(`tr[data-project-id="${jobId}"]`);
            if (projectRow) {
                const projectName = projectRow.querySelector('[data-field="name"]').textContent;
                document.getElementById('collaborateProjectName').textContent = projectName;
            }
            
            // 加载可用的协作者
            loadAvailableCollaborators();
            
            // 加载现有协作者
            loadProjectCollaborations(jobId);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('collaborateModal'));
            modal.show();
        }

        // 处理下拉菜单定位
        document.addEventListener('DOMContentLoaded', function() {
            const dropdowns = document.querySelectorAll('.dropdown');
            
            dropdowns.forEach(dropdown => {
                const button = dropdown.querySelector('.more-btn');
                const menu = dropdown.querySelector('.dropdown-menu');
                
                button.addEventListener('click', function(e) {
                    const rect = button.getBoundingClientRect();
                    const spaceBelow = window.innerHeight - rect.bottom;
                    
                    // 计算左侧位置，确保右边缘对齐
                    const menuWidth = 110; // 下拉菜单的最小宽度
                    let leftPosition = rect.right - menuWidth - 15; // 15px 是右侧边距
                    
                    // 如果下方空间不足，向上展开
                    if (spaceBelow < 200) {
                        menu.style.bottom = (window.innerHeight - rect.top) + 'px';
                        menu.style.top = 'auto';
                    } else {
                        menu.style.top = (rect.bottom + 5) + 'px';
                        menu.style.bottom = 'auto';
                    }
                    
                    menu.style.left = leftPosition + 'px';
                });
            });
        });

        // 表单验证
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        })()

        // 加载来源选项
        function loadSourceOptions() {
            fetch('/api/sources')
                .then(response => response.json())
                .then(sources => {
                    const sourceSelect = document.querySelector('select[name="source"]');
                    if (!sourceSelect) {
                        console.error('Source select element not found');
                        return;
                    }

                    // 保存默认选项
                    const defaultOption = sourceSelect.querySelector('option');
                    sourceSelect.innerHTML = '';
                    sourceSelect.appendChild(defaultOption);
                    
                    sources.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source.id;
                        option.textContent = source.name;
                        sourceSelect.appendChild(option);
                    });

                    console.log('Sources loaded successfully');
                })
                .catch(error => {
                    console.error('Error loading sources:', error);
                    showToast('错误', '加载来源选项失败');
                });
        }

        // 加载类型选项
        function loadBoardTypes() {
            fetch('/api/board-types')
                .then(response => response.json())
                .then(types => {
                    const typeSelect = document.querySelector('select[name="board_type"]');
                    if (!typeSelect) {
                        console.error('Board type select element not found');
                        return;
                    }

                    // 保存默认选项
                    const defaultOption = typeSelect.querySelector('option');
                    typeSelect.innerHTML = '';
                    typeSelect.appendChild(defaultOption);
                    
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.name;
                        typeSelect.appendChild(option);
                    });

                    console.log('Board types loaded successfully');
                })
                .catch(error => {
                    console.error('Error loading board types:', error);
                    showToast('错误', '加载电路板类型失败');
                });
        }

        // 加载元器件列表
        function loadComponents() {
            fetch('/api/components')
                .then(response => response.json())
                .then(components => {
                    const componentsList = document.querySelector('.components-list .row');
                    if (!componentsList) {
                        console.error('Components list element not found');
                        return;
                    }

                    // 完全清空之前的内容
                    componentsList.innerHTML = '';

                    componentsList.innerHTML = components.map(component => `
                                                        <div class="col-md-4">
                                    <div class="component-item">
                                        <div class="form-check component-info">
                                            <input class="form-check-input component-checkbox" type="checkbox" 
                                                   value="${component.id}" id="component${component.id}">
                                            <label class="form-check-label" for="component${component.id}">
                                                <div class="component-name">${component.name}</div>
                                                <div class="component-model">${component.model}</div>
                                            </label>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="component-price me-2">¥${component.price.toFixed(2)}</div>
                                            <div class="quantity-input" style="display: none;">
                                                <div class="input-group">
                                                    <input type="number" class="form-control" min="1" value="1">
                                                    <div class="input-group-buttons">
                                                        <button type="button" class="btn-up" onclick="adjustQuantity(this, 1)">
                                                            <i class="fas fa-caret-up"></i>
                                                        </button>
                                                        <button type="button" class="btn-down" onclick="adjustQuantity(this, -1)">
                                                            <i class="fas fa-caret-down"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    `).join('');

                    // 添加复选框事件监听 - 只绑定新建项目模态框中的复选框
                    document.querySelectorAll('#addProjectModal .component-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const quantityInput = this.closest('.component-item').querySelector('.quantity-input');
                            quantityInput.style.display = this.checked ? 'block' : 'none';
                            updateSelectedCount();
                        });
                    });

                    // 触发自定义事件，通知搜索功能组件已加载
                    const componentsLoadedEvent = new CustomEvent('componentsLoaded', { 
                        detail: { container: componentsList } 
                    });
                    document.dispatchEvent(componentsLoadedEvent);

                    // 清空搜索框，确保每次加载元器件时搜索状态正确
                    const searchInput = document.getElementById('componentSearch');
                    if (searchInput) {
                        searchInput.value = '';
                    }

                    console.log('Components loaded successfully');
                })
                .catch(error => {
                    console.error('Error loading components:', error);
                    alert('加载元器件列表失败');
                });
        }

        // 更新已选择的元器件数量
        function updateSelectedCount() {
            try {
                // 只统计新建项目模态框中的选中元器件
                const count = document.querySelectorAll('#addProjectModal .component-checkbox:checked').length;
                const countElement = document.getElementById('selectedComponentCount');
                if (countElement) {
                    countElement.textContent = count;
                }
            } catch (error) {
                console.error('Error in updateSelectedCount:', error);
            }
        }

        // 重置元器件选择状态
        function resetComponentsSelection() {
            try {
                // 清除全局状态 - 这是关键！
                if (window.addProjectComponentStates) {
                    window.addProjectComponentStates.clear();
                }

                // 重置所有元器件复选框 - 只重置新建项目模态框中的
                const checkboxes = document.querySelectorAll('#addProjectModal .component-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const quantityInput = checkbox.closest('.component-item').querySelector('.quantity-input');
                    if (quantityInput) {
                        quantityInput.style.display = 'none';
                        const numberInput = quantityInput.querySelector('input[type="number"]');
                        if (numberInput) {
                            numberInput.value = '1';
                        }
                    }
                });

                // 重置计数器
                const countElement = document.getElementById('selectedComponentCount');
                if (countElement) {
                    countElement.textContent = '0';
                }

                // 清空搜索框并重置过滤状态
                const searchInput = document.getElementById('componentSearch');
                if (searchInput) {
                    searchInput.value = '';
                    // 重置搜索过滤 - 显示所有元器件
                    const componentsContainer = document.querySelector('#addProjectModal .components-list .row');
                    if (componentsContainer) {
                        componentsContainer.querySelectorAll('.col-md-4').forEach(col => {
                            col.style.display = '';
                        });
                    }
                }

                console.log('Components selection reset successfully');
            } catch (error) {
                console.error('Error in resetComponentsSelection:', error);
            }
        }

        // 调整数量的函数
        function adjustQuantity(button, delta) {
            const input = button.closest('.input-group').querySelector('input');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, value + delta); // 确保最小值为1
            input.value = value;
            
            // 阻止事件冒泡，防止触发父元素的点击事件
            event.stopPropagation();
        }

        // 为所有数量输入框添加输入验证
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('input', function(e) {
                if (e.target.matches('.quantity-input input[type="number"]')) {
                    let value = parseInt(e.target.value) || 1;
                    value = Math.max(1, value); // 确保最小值为1
                    e.target.value = value;
                }
            });
        });


        // 修改提交表单的代码
        document.getElementById('submitProject').addEventListener('click', function() {
            const form = document.getElementById('addProjectForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            // 收集表单数据
            const formData = new FormData(form);
            
            // 获取来源和类型的名称
            const sourceSelect = form.querySelector('[name="source"]');
            const typeSelect = form.querySelector('[name="board_type"]');
            const sourceName = sourceSelect.options[sourceSelect.selectedIndex].text;
            const typeName = typeSelect.options[typeSelect.selectedIndex].text;
            
            // 获取选中的元器件 - 只从新建项目模态框中获取
            const selectedComponents = Array.from(document.querySelectorAll('#addProjectModal .component-checkbox:checked')).map(checkbox => {
                const componentItem = checkbox.closest('.component-item');
                const name = componentItem.querySelector('.component-name').textContent;
                const model = componentItem.querySelector('.component-model').textContent;
                const price = parseFloat(componentItem.querySelector('.component-price').textContent.replace('¥', ''));
                const quantity = parseInt(componentItem.querySelector('.quantity-input input').value);
                return {
                    id: parseInt(checkbox.value),
                    name: name,
                    model: model,
                    price: price,
                    quantity: quantity
                };
            });

            // 处理要求文本
            const requirementsText = formData.get('requirements');
            const requirements = [];
            if (requirementsText) {
                const requirementMatches = requirementsText.match(/##(.+?)##([^#]+)/g);
                if (requirementMatches) {
                    requirementMatches.forEach((match, index) => {
                        const titleMatch = match.match(/##(.+?)##/);
                        const title = titleMatch ? titleMatch[1].trim() : '';
                        const content = match.replace(/##.+?##/, '').trim();
                        if (title && content) {
                            requirements.push({
                                title: title,
                                content: content,
                                color: getRequirementColor(index)
                            });
                        }
                    });
                }
            }

            // 构建项目数据
            const projectData = {
                source: sourceName, // 使用名称而不是ID
                source_id: formData.get('source'), // 保留ID以供后端使用
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                board_type: typeName, // 使用名称而不是ID
                board_type_id: formData.get('board_type'), // 保留ID以供后端使用
                status: formData.get('status'), // 使用表单中选择的状态
                remark: formData.get('remark') || '',
                components: selectedComponents,
                requirements: requirements
            };

            // 发送到服务器
            fetch('/api/jobs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(projectData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // 添加新行到表格
                const tbody = document.querySelector('.table tbody');
                const rowCount = tbody.children.length;
                const newRow = createTableRow(data.project, rowCount + 1);
                tbody.insertAdjacentHTML('beforeend', newRow);

                // 为新添加的行初始化下拉菜单定位
                const lastRow = tbody.lastElementChild;
                initializeDropdownPosition(lastRow.querySelector('.dropdown'));

                // 更新搜索功能的行引用
                if (window.updateProjectSearchRows) {
                    window.updateProjectSearchRows();
                }

                // 更新统计卡片
                updateStatsCards();
                
                // 更新元器件总价格
                if (typeof updateComponentsPrice === 'function') {
                    updateComponentsPrice();
                }
                
                // 关闭模态框并重置表单
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
                modal.hide();
                form.reset();
                form.classList.remove('was-validated');
                
                // 手动重置元器件选择状态
                resetComponentsSelection();
                
                // 显示成功消息
                showToast('创建成功', '新项目已成功添加到列表中');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('创建失败', error.message || '无法创建新项目，请重试');
            });
        });

        // 创建表格行 HTML
        function createTableRow(project, index) {
            // 构建协作标识HTML
            let collaborationBadge = '';
            if (project.user_role && project.user_role !== 'owner') {
                collaborationBadge = `
                    <div class="collaboration-badge">
                        <i class="fas fa-users"></i>
                        <span>协作项目 - 所有者: ${project.owner_username || '未知'}</span>
                    </div>
                `;
            }

            // 根据用户角色决定显示哪些操作
            let actionItems = '';
            
            // 只有项目所有者可以进行的操作
            if (!project.user_role || project.user_role === 'owner') {
                actionItems += `
                    <li><a class="dropdown-item edit" href="#" onclick="editProject('${project.id}')">
                        <i class="fas fa-edit"></i><span>修改</span>
                    </a></li>
                `;
            }

            // 项目所有者和写权限协作者可以上传
            if (!project.user_role || project.user_role === 'owner' || project.user_role === 'write') {
                actionItems += `
                    <li><a class="dropdown-item upload" href="#" onclick="uploadFiles('${project.id}')">
                        <i class="fas fa-upload"></i><span>上传</span>
                    </a></li>
                `;
            }

            // 所有用户都可以下载
            actionItems += `
                <li><a class="dropdown-item download" href="#" onclick="downloadFiles('${project.id}')">
                    <i class="fas fa-download"></i><span>下载</span>
                </a></li>
            `;

            // 只有项目所有者可以进行的操作
            if (!project.user_role || project.user_role === 'owner') {
                actionItems += `
                    <li><a class="dropdown-item share" href="#" onclick="shareProject('${project.id}')">
                        <i class="fas fa-share-alt"></i><span>分享</span>
                    </a></li>
                    <li><a class="dropdown-item collaborate" href="#" onclick="collaborateProject('${project.id}')">
                        <i class="fas fa-users"></i><span>共享</span>
                    </a></li>
                    <li><a class="dropdown-item delete" href="#" onclick="deleteProject('${project.id}')">
                        <i class="fas fa-trash-alt"></i><span>删除</span>
                    </a></li>
                `;
            } else {
                // 协作者可以退出协作
                actionItems += `
                    <li><a class="dropdown-item leave-collaboration" href="#" onclick="leaveCollaboration('${project.id}')">
                        <i class="fas fa-sign-out-alt"></i><span>退出协作</span>
                    </a></li>
                `;
            }

            const row = `
                <tr>
                    <td class="col-index">${index}</td>
                    <td class="col-source">${escapeHtml(project.source)}</td>
                    <td class="col-name">
                        <div class="d-flex align-items-center justify-content-center">
                            <span>${escapeHtml(project.name)}</span>
                            ${project.is_shared_by_me ? `<i class="fas fa-share-alt ms-2 share-icon-owner" title="已共享给其他用户"></i>` : ''}
                            ${project.is_shared_to_me ? `<i class="fas fa-users ms-2 share-icon-collaborator" title="来自 ${project.owner_username} 的共享项目"></i>` : ''}
                        </div>
                        ${collaborationBadge}
                    </td>
                    <td class="col-price">¥${project.price.toFixed(2)}</td>
                    <td class="col-type">${escapeHtml(project.board_type)}</td>
                    <td class="col-status">
                        <span class="status-badge" data-status="${project.status}" style="${project.status_color ? `background: ${project.status_color};` : ''}">
                            ${project.status}
                        </span>
                    </td>
                    <td class="col-remark">
                        <div class="remark-text text-center" title="${escapeHtml(project.remark)}">
                            ${escapeHtml(project.remark) || '-'}
                        </div>
                    </td>
                    <td class="col-components">
                        <button class="view-btn components" onclick="viewComponents('${project.id}')">
                            查看元件
                        </button>
                    </td>
                    <td class="col-requirements">
                        <button class="view-btn requirements" onclick="viewRequirements('${project.id}')">
                            查看要求
                        </button>
                    </td>
                    <td class="col-actions">
                        <div class="dropdown">
                            <button class="more-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                ${actionItems}
                            </ul>
                        </div>
                    </td>
                </tr>
            `;
            
            return row;
        }

        // 初始化下拉菜单定位函数
        function initializeDropdownPosition(dropdown) {
            if (!dropdown) return;
            
            const button = dropdown.querySelector('.more-btn');
            const menu = dropdown.querySelector('.dropdown-menu');
            
            button.addEventListener('click', function(e) {
                const rect = button.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                const menuWidth = 110; // 下拉菜单的最小宽度
                
                // 计算左侧位置，确保右边缘对齐
                let leftPosition = rect.right - menuWidth;
                
                // 如果下方空间不足，向上展开
                if (spaceBelow < 200) {
                    menu.style.bottom = (window.innerHeight - rect.top) + 'px';
                    menu.style.top = 'auto';
                } else {
                    menu.style.top = rect.bottom + 'px';
                    menu.style.bottom = 'auto';
                }
                
                menu.style.left = leftPosition + 'px';
                menu.style.position = 'fixed';
            });
        }

        // 页面加载时初始化所有下拉菜单
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                initializeDropdownPosition(dropdown);
            });
        });

        // 更新统计卡片
        function updateStatsCards() {
            const tbody = document.querySelector('.table tbody');
            const rows = tbody.getElementsByTagName('tr');
            
            // 过滤掉no-results-row等非项目行
            const projectRows = Array.from(rows).filter(row => !row.classList.contains('no-results-row'));
            
            let totalProjects = projectRows.length;
            let incompleteProjects = 0;
            let totalPrice = 0;
            let incompletePrice = 0;

            projectRows.forEach(row => {
                const statusBadge = row.querySelector('.status-badge');
                const priceCell = row.querySelector('.col-price');
                
                if (statusBadge && priceCell) {
                    const status = statusBadge.dataset.status || statusBadge.textContent.trim();
                    const priceText = priceCell.textContent;
                    const price = parseFloat(priceText.replace('¥', '')) || 0;
                    
                    totalPrice += price;
                    
                    if (status !== '已完成') {
                        incompleteProjects++;
                        incompletePrice += price;
                    }
                }
            });

            // 更新项目数量统计（直接更新文本内容）
            const totalProjectsElement = document.querySelector('#total-projects');
            if (totalProjectsElement) {
                totalProjectsElement.textContent = totalProjects;
            }
            
            const incompleteProjectsElement = document.querySelector('#incomplete-projects');
            if (incompleteProjectsElement) {
                incompleteProjectsElement.textContent = incompleteProjects;
            }

            // 更新价格统计（更新price-visible span中的内容）
            const totalPriceElement = document.querySelector('#total-price .price-visible');
            if (totalPriceElement) {
                totalPriceElement.textContent = '¥' + totalPrice.toFixed(2);
            }
            
            const incompletePriceElement = document.querySelector('#incomplete-price .price-visible');
            if (incompletePriceElement) {
                incompletePriceElement.textContent = '¥' + incompletePrice.toFixed(2);
            }
            
            // 同时更新元器件总价格
            if (typeof updateComponentsPrice === 'function') {
                updateComponentsPrice();
            }
        }

        // 获取要求颜色
        function getRequirementColor(index) {
            const colors = ['#2196F3', '#4CAF50', '#FF9800', '#E91E63', '#9C27B0'];
            return colors[index % colors.length];
        }

        // HTML 转义函数
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 添加提示消息组件
        function showToast(title, message, type = 'success') {
            // 移除现有的 toast-container（如果存在）
            const existingContainer = document.querySelector('.toast-container');
            if (existingContainer) {
                existingContainer.remove();
            }

            // 根据类型设置颜色
            let bgColor = '#28a745'; // 成功绿色
            let textColor = '#fff';
            let icon = 'fas fa-check-circle';
            
            switch(type) {
                case 'success':
                    bgColor = '#28a745';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                case 'danger':
                    bgColor = '#dc3545';
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = '#ffc107';
                    textColor = '#000';
                    icon = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                    bgColor = '#17a2b8';
                    icon = 'fas fa-info-circle';
                    break;
            }

            const toastHTML = `
                <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" 
                         style="background-color: ${bgColor}; color: ${textColor}; border: none;">
                        <div class="toast-header" style="background-color: ${bgColor}; color: ${textColor}; border: none;">
                            <i class="${icon} me-2"></i>
                            <strong class="me-auto">${title}</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close" 
                                    style="filter: ${textColor === '#fff' ? 'invert(1)' : 'none'};"></button>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', toastHTML);

            // 自动隐藏
            const delay = type === 'error' || type === 'danger' ? 5000 : 3000;
            setTimeout(() => {
                const container = document.querySelector('.toast-container');
                if (container) {
                    container.remove();
                }
            }, delay);
        }

        // 当模态框显示时加载所有选项
        document.getElementById('addProjectModal').addEventListener('show.bs.modal', function () {
            console.log('Modal is opening, loading data...');
            loadSourceOptions();
            loadBoardTypes();
            loadComponents();
            loadStatusOptions();
            
            // 确保元器件状态被重置
            setTimeout(() => {
                resetComponentsSelection();
            }, 100);
        });

        // 当模态框隐藏时重置表单和元器件选择
        document.getElementById('addProjectModal').addEventListener('hidden.bs.modal', function () {
            const form = document.getElementById('addProjectForm');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
            }

            // 重置元器件选择 - 只重置新建项目模态框中的
            const checkboxes = document.querySelectorAll('#addProjectModal .component-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const quantityInput = checkbox.closest('.component-item').querySelector('.quantity-input');
                if (quantityInput) {
                    quantityInput.style.display = 'none';
                    const numberInput = quantityInput.querySelector('input[type="number"]');
                    if (numberInput) {
                        numberInput.value = '1';
                    }
                }
            });

            // 重置计数器
            const countElement = document.getElementById('selectedComponentCount');
            if (countElement) {
                countElement.textContent = '0';
            }

            // 清空搜索框
            const searchInput = document.getElementById('componentSearch');
            if (searchInput) {
                searchInput.value = '';
                // 重置搜索过滤
                document.querySelectorAll('.component-item').forEach(item => {
                    const parentCol = item.closest('.col-md-4');
                    if (parentCol) {
                        parentCol.style.display = '';
                    }
                });
            }
        });

        // 项目搜索功能
        function initProjectSearch() {
            const searchInput = document.getElementById('projectSearchInput');
            const tableBody = document.querySelector('.table tbody');
            let originalRows = Array.from(tableBody.querySelectorAll('tr'));
            let noResultsRow = null;

            function showNoResults() {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = `
                        <td colspan="10" class="no-results">
                            <i class="fas fa-search mb-2"></i><br>
                            没有找到匹配的项目
                        </td>
                    `;
                }
                tableBody.appendChild(noResultsRow);
            }

            function hideNoResults() {
                if (noResultsRow && noResultsRow.parentNode) {
                    noResultsRow.parentNode.removeChild(noResultsRow);
                }
            }

            function performSearch(searchText) {
                const lowerSearchText = searchText.toLowerCase().trim();
                let visibleCount = 0;

                // 隐藏无结果提示
                hideNoResults();

                // 如果搜索为空，显示所有项目
                if (!lowerSearchText) {
                    originalRows.forEach((row, index) => {
                        row.classList.remove('hidden');
                        // 更新序号
                        const indexCell = row.querySelector('.col-index');
                        if (indexCell) {
                            indexCell.textContent = index + 1;
                        }
                    });
                    return;
                }

                // 执行搜索
                originalRows.forEach(row => {
                    const nameCell = row.querySelector('.col-name span');
                    const remarkCell = row.querySelector('.col-remark .remark-text');
                    const sourceCell = row.querySelector('.col-source');
                    const typeCell = row.querySelector('.col-type');
                    
                    if (!nameCell) return;

                    const projectName = nameCell.textContent.toLowerCase();
                    const projectRemark = remarkCell ? remarkCell.textContent.toLowerCase() : '';
                    const projectSource = sourceCell ? sourceCell.textContent.toLowerCase() : '';
                    const projectType = typeCell ? typeCell.textContent.toLowerCase() : '';

                    // 检查是否匹配项目名称、备注、来源或类型
                    const isMatch = projectName.includes(lowerSearchText) || 
                                   projectRemark.includes(lowerSearchText) ||
                                   projectSource.includes(lowerSearchText) ||
                                   projectType.includes(lowerSearchText);

                    if (isMatch) {
                        row.classList.remove('hidden');
                        visibleCount++;
                        // 更新序号
                        const indexCell = row.querySelector('.col-index');
                        if (indexCell) {
                            indexCell.textContent = visibleCount;
                        }
                    } else {
                        row.classList.add('hidden');
                    }
                });

                // 如果没有匹配的结果，显示无结果提示
                if (visibleCount === 0) {
                    showNoResults();
                }
            }

            // 监听搜索输入
            searchInput.addEventListener('input', function(e) {
                performSearch(e.target.value);
            });

            // 监听搜索框清空事件
            searchInput.addEventListener('search', function() {
                if (this.value === '') {
                    performSearch('');
                }
            });

            // 保存原始行引用（当有新项目添加时更新）
            window.updateProjectSearchRows = function() {
                originalRows = Array.from(tableBody.querySelectorAll('tr:not(.no-results-row)'));
            };
        }

        // 初始化加载
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Document loaded, initializing...');
            // 为了测试，可以直接调用加载函数
            loadSourceOptions();
            loadBoardTypes();
            loadComponents();
            loadStatusOptions();
            initProjectSearch(); // 初始化项目搜索功能
        });

        // 保存修改
        document.getElementById('updateProject').addEventListener('click', function() {
            const form = document.getElementById('editProjectForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const projectId = document.getElementById('editProjectId').value;
            const formData = new FormData(form);

            // 获取来源和类型的名称
            const sourceSelect = form.querySelector('[name="source"]');
            const typeSelect = form.querySelector('[name="board_type"]');
            const sourceName = sourceSelect.options[sourceSelect.selectedIndex].text;
            const typeName = typeSelect.options[typeSelect.selectedIndex].text;

            // 获取选中的元器件
            const selectedComponents = Array.from(document.querySelectorAll('#editComponentsList .component-checkbox:checked')).map(checkbox => {
                const componentItem = checkbox.closest('.component-item');
                const name = componentItem.querySelector('.component-name').textContent;
                const model = componentItem.querySelector('.component-model').textContent;
                const price = parseFloat(componentItem.querySelector('.component-price').textContent.replace('¥', ''));
                const quantity = parseInt(componentItem.querySelector('.quantity-input input').value);
                return {
                    id: parseInt(checkbox.value),
                    name: name,
                    model: model,
                    price: price,
                    quantity: quantity
                };
            });

            // 处理要求文本
            const requirementsText = formData.get('requirements');
            const requirements = [];
            if (requirementsText) {
                const requirementMatches = requirementsText.match(/##(.+?)##([^#]+)/g);
                if (requirementMatches) {
                    requirementMatches.forEach((match, index) => {
                        const titleMatch = match.match(/##(.+?)##/);
                        const title = titleMatch ? titleMatch[1].trim() : '';
                        const content = match.replace(/##.+?##/, '').trim();
                        if (title && content) {
                            requirements.push({
                                title: title,
                                content: content,
                                color: getRequirementColor(index)
                            });
                        }
                    });
                }
            }

            // 构建项目数据
            const projectData = {
                source: sourceName,
                source_id: formData.get('source'),
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                board_type: typeName,
                board_type_id: formData.get('board_type'),
                status: formData.get('status'),
                remark: formData.get('remark') || '',
                components: selectedComponents,
                requirements: requirements
            };

            // 发送到服务器
            fetch(`/api/jobs/${projectId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(projectData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // 更新表格中的行
                updateTableRow(data.project);
                
                // 更新统计卡片
                updateStatsCards();
                
                // 更新元器件总价格
                if (typeof updateComponentsPrice === 'function') {
                    updateComponentsPrice();
                }
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
                modal.hide();
                
                // 显示成功消息
                showToast('修改成功', '项目信息已成功更新');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('修改失败', error.message || '无法更新项目信息，请重试');
            });
        });

        // 更新表格行
        function updateTableRow(project) {
            const tbody = document.querySelector('.table tbody');
            const existingRow = Array.from(tbody.children).find(row => {
                const editButton = row.querySelector('.dropdown-item.edit');
                return editButton && editButton.getAttribute('onclick').includes(project.id);
            });

            if (existingRow) {
                const rowIndex = Array.from(tbody.children).indexOf(existingRow) + 1;
                const newRowHtml = createTableRow(project, rowIndex);
                
                // 使用临时容器来创建DOM元素
                const temp = document.createElement('tbody');
                temp.innerHTML = newRowHtml;
                const newRow = temp.firstElementChild;
                
                // 替换旧行
                existingRow.replaceWith(newRow);
                
                // 为新行初始化下拉菜单
                const dropdown = newRow.querySelector('.dropdown');
                if (dropdown) {
                    initializeDropdownPosition(dropdown);
                }

                // 更新搜索功能的行引用
                if (window.updateProjectSearchRows) {
                    window.updateProjectSearchRows();
                }
            }
        }

        // 删除项目函数
        function deleteProject(jobId) {
            // 设置要删除的项目ID
            document.getElementById('deleteProjectId').value = jobId;
            
            // 显示确认对话框
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        }

        // 确认删除按钮点击事件
        document.getElementById('confirmDelete').addEventListener('click', function() {
            const jobId = document.getElementById('deleteProjectId').value;
            
            fetch(`/api/jobs/${jobId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // 从表格中移除该行
                const tbody = document.querySelector('.table tbody');
                const row = Array.from(tbody.children).find(row => {
                    const deleteButton = row.querySelector('.dropdown-item.delete');
                    return deleteButton && deleteButton.getAttribute('onclick').includes(jobId);
                });

                if (row) {
                    row.remove();
                    
                    // 更新剩余行的序号
                    const projectRows = Array.from(tbody.children).filter(row => !row.classList.contains('no-results-row'));
                    projectRows.forEach((row, index) => {
                        const indexCell = row.querySelector('.col-index');
                        if (indexCell) {
                            indexCell.textContent = index + 1;
                        }
                    });

                    // 更新搜索功能的行引用
                    if (window.updateProjectSearchRows) {
                        window.updateProjectSearchRows();
                    }
                }

                // 关闭确认对话框
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                modal.hide();

                // 更新统计卡片
                updateStatsCards();
                
                // 更新元器件总价格
                if (typeof updateComponentsPrice === 'function') {
                    updateComponentsPrice();
                }
                
                // 显示成功消息
                showToast('删除成功', '项目已从列表中移除');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('删除失败', error.message || '无法删除项目，请重试');
            });
        });

        // 元器件搜索功能（新建项目模态框）- 支持保持选中状态
        const addProjectSearchInput = document.getElementById('componentSearch');
        if (addProjectSearchInput) {
            // 搜索输入事件
            addProjectSearchInput.addEventListener('input', function(e) {
            const searchText = e.target.value.toLowerCase().trim();
            const componentsContainer = document.querySelector('#addProjectModal .components-list .row');
            
            if (!componentsContainer) return;
            
            // 在搜索之前保存当前所有元器件的选中状态
            const componentStates = new Map();
            componentsContainer.querySelectorAll('.component-item').forEach(item => {
                const checkbox = item.querySelector('.component-checkbox');
                const quantityInput = item.querySelector('.quantity-input input');
                if (checkbox) {
                    componentStates.set(checkbox.value, {
                        checked: checkbox.checked,
                        quantity: quantityInput ? quantityInput.value : '1',
                        displayQuantity: checkbox.checked ? 'block' : 'none'
                    });
                }
            });
            
            // 如果搜索框为空，显示所有元器件并恢复状态
            if (!searchText) {
                componentsContainer.querySelectorAll('.col-md-4').forEach(col => {
                    col.style.display = '';
                    // 恢复选中状态
                    const componentItem = col.querySelector('.component-item');
                    const checkbox = componentItem.querySelector('.component-checkbox');
                    if (checkbox) {
                        const state = componentStates.get(checkbox.value);
                        if (state) {
                            checkbox.checked = state.checked;
                            const quantityDiv = componentItem.querySelector('.quantity-input');
                            if (quantityDiv) {
                                quantityDiv.style.display = state.displayQuantity;
                                const numberInput = quantityDiv.querySelector('input');
                                if (numberInput) {
                                    numberInput.value = state.quantity;
                                }
                            }
                        }
                    }
                });
                // 更新选中计数
                updateSelectedCount();
                return;
            }
            
            // 根据搜索文本过滤元器件，但保持选中状态
            componentsContainer.querySelectorAll('.col-md-4').forEach(col => {
                const componentItem = col.querySelector('.component-item');
                if (componentItem) {
                    const text = componentItem.textContent.toLowerCase();
                    col.style.display = text.includes(searchText) ? '' : 'none';
                    
                    // 即使隐藏的元器件也要保持选中状态
                    const checkbox = componentItem.querySelector('.component-checkbox');
                    if (checkbox) {
                        const state = componentStates.get(checkbox.value);
                        if (state) {
                            checkbox.checked = state.checked;
                            const quantityDiv = componentItem.querySelector('.quantity-input');
                            if (quantityDiv) {
                                quantityDiv.style.display = state.displayQuantity;
                                const numberInput = quantityDiv.querySelector('input');
                                if (numberInput) {
                                    numberInput.value = state.quantity;
                                }
                            }
                        }
                    }
                }
            });
            
                         // 更新选中计数（包括隐藏的选中项）
             updateSelectedCount();
         });

         // 添加键盘事件支持（ESC键清空搜索）
         addProjectSearchInput.addEventListener('keydown', function(e) {
             if (e.key === 'Escape') {
                 this.value = '';
                 this.dispatchEvent(new Event('input'));
             }
         });

         // 搜索框获得焦点时的提示
         addProjectSearchInput.addEventListener('focus', function() {
             this.setAttribute('placeholder', '搜索元器件名称或型号... (ESC清空)');
         });

         addProjectSearchInput.addEventListener('blur', function() {
             this.setAttribute('placeholder', '搜索元器件...');
         });
     }

        // 元器件搜索功能（编辑模态框）
        document.getElementById('editComponentSearch')?.addEventListener('input', function(e) {
            const searchText = e.target.value.toLowerCase();
            document.querySelectorAll('#editComponentsList .component-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchText) ? '' : 'none';
            });
        });

        // 加载状态选项
        function loadStatusOptions() {
            fetch('/api/status')
                .then(response => response.json())
                .then(statuses => {
                    // 更新状态选择框
                    const statusSelects = document.querySelectorAll('select[name="status"]');
                    statusSelects.forEach(select => {
                        // 保存默认选项
                        const defaultOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        if (defaultOption) {
                            select.appendChild(defaultOption);
                        }
                        
                        // 添加状态选项
                        statuses.forEach(status => {
                            const option = document.createElement('option');
                            option.value = status.value;
                            option.textContent = status.label;
                            select.appendChild(option);
                        });
                    });

                    // 动态添加状态样式
                    let styleSheet = document.getElementById('status-styles');
                    if (!styleSheet) {
                        styleSheet = document.createElement('style');
                        styleSheet.id = 'status-styles';
                        document.head.appendChild(styleSheet);
                    }

                    // 生成状态样式
                    const statusStyles = statuses.map(status => `
                        .status-badge[data-status="${status.value}"] {
                            background: ${status.color || 'var(--gradient-1)'};
                        }
                    `).join('\n');

                    styleSheet.textContent = statusStyles;
                    
                    console.log('Status options loaded successfully');
                })
                .catch(error => {
                    console.error('Error loading status options:', error);
                    showToast('错误', '加载状态选项失败');
                });
        }

        // 文件上传相关代码
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const fileTree = document.getElementById('fileTree');
            const startUploadBtn = document.getElementById('startUpload');
            const uploadProgress = document.querySelector('.upload-progress');
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.querySelector('.progress-text');
            const currentFileDiv = document.querySelector('.current-file');
            const currentFileName = document.querySelector('.current-file-name');

            // 文件大小格式化
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // 创建文件树结构
            function createFileTree(files) {
                fileTree.innerHTML = '';
                const root = { children: new Map() };

                // 按路径排序文件
                const sortedFiles = Array.from(files).sort((a, b) => {
                    const pathA = a.webkitRelativePath || a.name;
                    const pathB = b.webkitRelativePath || b.name;
                    return pathA.localeCompare(pathB);
                });

                // 构建树形结构
                sortedFiles.forEach(file => {
                    const path = file.webkitRelativePath || file.name;
                    const parts = path.split('/');
                    let current = root;

                    parts.forEach((part, index) => {
                        if (!current.children.has(part)) {
                            current.children.set(part, {
                                name: part,
                                isFile: index === parts.length - 1,
                                file: index === parts.length - 1 ? file : null,
                                children: new Map()
                            });
                        }
                        current = current.children.get(part);
                    });
                });

                // 递归渲染树
                function renderTree(node, parentElement) {
                    const sortedChildren = Array.from(node.children.values())
                        .sort((a, b) => {
                            // 文件夹优先
                            if (!a.isFile && b.isFile) return -1;
                            if (a.isFile && !b.isFile) return 1;
                            return a.name.localeCompare(b.name);
                        });

                    sortedChildren.forEach(child => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'file-item' + (child.isFile ? '' : ' folder');
                        
                        // 创建内容容器
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'file-item-content';

                        // 添加折叠按钮（仅文件夹）
                        const toggleDiv = document.createElement('div');
                        toggleDiv.className = 'folder-toggle';
                        toggleDiv.innerHTML = '<i class="bi bi-chevron-right"></i>';
                        toggleDiv.style.display = child.isFile ? 'none' : 'flex';
                        contentDiv.appendChild(toggleDiv);

                        // 添加图标
                        const icon = document.createElement('i');
                        icon.className = 'bi ' + (child.isFile ? 'bi-file-earmark' : 'bi-folder');
                        contentDiv.appendChild(icon);

                        // 添加名称
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'file-name';
                        nameSpan.textContent = child.name;
                        contentDiv.appendChild(nameSpan);

                        // 如果是文件，添加大小和状态
                        if (child.isFile) {
                            const sizeSpan = document.createElement('small');
                            sizeSpan.className = 'text-muted file-size';
                            sizeSpan.textContent = formatFileSize(child.file.size);
                            contentDiv.appendChild(sizeSpan);

                            const statusSpan = document.createElement('span');
                            statusSpan.className = 'upload-status pending';
                            statusSpan.textContent = '待上传';
                            contentDiv.appendChild(statusSpan);

                            // 添加重试按钮
                            const retryBtn = document.createElement('button');
                            retryBtn.type = 'button';
                            retryBtn.className = 'btn btn-sm btn-link retry-btn';
                            retryBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 重试';
                            retryBtn.style.display = 'none';
                            retryBtn.onclick = (e) => {
                                e.stopPropagation();
                                uploadFile(child.file);
                            };
                            contentDiv.appendChild(retryBtn);

                            // 保存文件路径用于状态更新
                            itemDiv.dataset.path = child.file.webkitRelativePath || child.file.name;
                        } else {
                            // 文件夹点击事件
                            contentDiv.onclick = (e) => {
                                e.stopPropagation();
                                const childrenDiv = itemDiv.querySelector('.file-children');
                                const toggle = itemDiv.querySelector('.folder-toggle');
                                const isOpen = toggle.classList.contains('open');
                                
                                // 切换折叠状态
                                toggle.classList.toggle('open');
                                childrenDiv.style.display = isOpen ? 'none' : 'block';
                            };
                        }

                        itemDiv.appendChild(contentDiv);

                        // 创建子项容器
                        const childrenDiv = document.createElement('div');
                        childrenDiv.className = 'file-children';
                        childrenDiv.style.display = 'none'; // 默认折叠
                        itemDiv.appendChild(childrenDiv);

                        parentElement.appendChild(itemDiv);

                        // 递归处理子项
                        if (!child.isFile) {
                            renderTree(child, childrenDiv);
                        }
                    });
                }

                renderTree(root, fileTree);
                
                // 启用上传按钮
                startUploadBtn.disabled = false;
            }

            // 更新文件状态
            function updateFileStatus(filePath, status, message = '') {
                const fileItem = fileTree.querySelector(`.file-item[data-path="${filePath}"]`);
                if (fileItem) {
                    const statusSpan = fileItem.querySelector('.upload-status');
                    const retryBtn = fileItem.querySelector('.retry-btn');
                    
                    statusSpan.className = 'upload-status ' + status;
                    statusSpan.textContent = message;

                    // 显示/隐藏重试按钮
                    if (status === 'error') {
                        retryBtn.style.display = 'inline-block';
                    } else {
                        retryBtn.style.display = 'none';
                    }
                }
            }

            // 检查所有文件是否上传完成
            function checkAllFilesUploaded() {
                const allFiles = fileTree.querySelectorAll('.file-item:not(.folder)');
                const successFiles = fileTree.querySelectorAll('.upload-status.success');
                return allFiles.length === successFiles.length;
            }

            // 上传单个文件
            async function uploadFile(file, sessionId) {
                // 优先使用自定义的完整路径，然后是webkitRelativePath，最后是文件名
                const filePath = file._fullPath || file.webkitRelativePath || file.name;
                const formData = new FormData();
                formData.append('files[]', file, filePath);
                formData.append('session_id', sessionId);

                // 更新当前文件名显示
                currentFileDiv.classList.remove('d-none');
                currentFileName.textContent = filePath;
                updateFileStatus(filePath, 'uploading', '上传中');

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        updateFileStatus(filePath, 'success', '已完成');
                        return result;
                    } else {
                        throw new Error('上传失败');
                    }
                } catch (error) {
                    updateFileStatus(filePath, 'error', '失败');
                    showToast('错误', `文件 ${filePath} 上传失败`, 'danger');
                    return false;
                }
            }

            // 开始上传会话
            async function startUploadSession(projectId, totalFiles) {
                try {
                    const response = await fetch('/api/upload/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            project_id: projectId,
                            total_files: totalFiles
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        return result.session_id;
                    } else {
                        throw new Error('创建上传会话失败');
                    }
                } catch (error) {
                    showToast('错误', error.message, 'danger');
            return null;
                }
            }

            // 完成上传会话
            async function completeUploadSession(sessionId) {
                try {
                    const response = await fetch('/api/upload/complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showToast('成功', result.message, 'success');
                        return true;
                    } else {
                        throw new Error('完成上传失败');
                    }
                } catch (error) {
                    showToast('错误', error.message, 'danger');
                    return false;
                }
            }

            // 监听文件选择
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    createFileTree(files);
                    uploadProgress.classList.remove('d-none');
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                    
                    // 重置当前文件显示
                    currentFileDiv.classList.add('d-none');
                    currentFileName.textContent = '';
                    
                    // 启用上传按钮
                    startUploadBtn.disabled = false;
                }
            });

            // 开始上传
            startUploadBtn.addEventListener('click', async function() {
                // 优先使用全局selectedFiles，如果为空则使用fileInput.files
                const files = (typeof selectedFiles !== 'undefined' && selectedFiles.length > 0) ? selectedFiles : Array.from(fileInput.files);
                if (files.length === 0) {
                    showToast('提示', '请先选择要上传的文件！', 'warning');
                    return;
                }

                const projectId = currentProjectId;
                if (!projectId) {
                    showToast('错误', '无法确定项目ID', 'danger');
                    return;
                }

                startUploadBtn.disabled = true;
                uploadProgress.classList.remove('d-none');
                let uploadedCount = 0;
                const totalFiles = files.length;

                // 创建上传会话
                const sessionId = await startUploadSession(projectId, totalFiles);
                if (!sessionId) {
                    startUploadBtn.disabled = false;
                    return;
                }

                try {
                for (let file of files) {
                        const result = await uploadFile(file, sessionId);
                        if (result && !result.error) {
                        uploadedCount++;
                    // 更新总进度
                    const progress = Math.round((uploadedCount / totalFiles) * 100);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                }
                    }

                    // 所有文件上传完成，完成会话
                    if (uploadedCount === totalFiles) {
                        await completeUploadSession(sessionId);
                        showToast('成功', '所有文件上传完成', 'success');
                } else {
                        showToast('警告', '部分文件上传失败，请重试', 'warning');
                        // 部分失败时重新启用按钮，允许用户重试
                        startUploadBtn.disabled = false;
                    }
                } catch (error) {
                    showToast('错误', '上传过程中发生错误', 'danger');
                    // 发生错误时重新启用按钮，允许用户重试
                    startUploadBtn.disabled = false;
                } finally {
                    // 上传完成后的处理
                    currentFileDiv.classList.add('d-none');
                    // 只有在完全成功时才保持按钮禁用状态
                }
            });

            // 清空按钮事件处理程序
            fileInput.addEventListener('click', function() {
                // 清空文件输入框时重置所有状态
                if (this.value) {
                    this.value = '';
                    fileTree.innerHTML = '';
                    uploadProgress.classList.add('d-none');
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                    currentFileDiv.classList.add('d-none');
                    startUploadBtn.disabled = true;
                }
            });

            // 模态框关闭时重置状态
            document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function () {
                fileInput.value = '';
                fileTree.innerHTML = '';
                uploadProgress.classList.add('d-none');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                currentFileDiv.classList.add('d-none');
                startUploadBtn.disabled = true;
                currentProjectId = null; // 重置项目ID
            });
        });

        // 元器件搜索功能
        document.addEventListener('DOMContentLoaded', function() {
            function handleComponentSearch(searchInput, listContainer) {
                if (!searchInput || !listContainer) return;

                let allComponents = [];
                let componentStates = new Map();
                
                // 将componentStates暴露到全局作用域，以便重置函数可以访问
                if (listContainer.closest('#addProjectModal')) {
                    window.addProjectComponentStates = componentStates;
                }

                // 保存元器件状态
                function saveComponentStates() {
                    const items = listContainer.querySelectorAll('.component-item');
                    // 先获取现有的状态
                    const currentStates = new Map(componentStates);
                    
                    items.forEach(item => {
                        const checkbox = item.querySelector('.component-checkbox');
                        const quantityInput = item.querySelector('.quantity-input input');
                        if (checkbox) {
                            const id = checkbox.value;
                            const existingState = currentStates.get(id);
                            
                            // 只有在复选框状态确实改变时才更新
                            if (!existingState || 
                                existingState.checked !== checkbox.checked || 
                                (quantityInput && existingState.quantity !== quantityInput.value)) {
                                componentStates.set(id, {
                                    checked: checkbox.checked,
                                    quantity: quantityInput ? quantityInput.value : '1',
                                    displayQuantity: checkbox.checked ? 'block' : 'none'
                                });
                            }
                        }
                    });
                    
                    // 保留不在当前视图中但已选中的元件状态
                    currentStates.forEach((state, id) => {
                        if (state.checked && !Array.from(items).some(item => 
                            item.querySelector('.component-checkbox')?.value === id)) {
                            componentStates.set(id, state);
                        }
                    });
                }

                // 初始化allComponents的函数
                function initializeAllComponents() {
                    const row = listContainer.querySelector('.row');
                    if (row && row.querySelectorAll('.component-item').length > 0) {
                        allComponents = Array.from(row.querySelectorAll('.component-item')).map(item => {
                            const col = document.createElement('div');
                            col.className = 'col-md-4';
                            col.appendChild(item.cloneNode(true));
                            return {
                                element: col,
                                text: item.textContent.toLowerCase(),
                                id: item.querySelector('.component-checkbox').value
                            };
                        });
                        console.log(`初始化了 ${allComponents.length} 个元器件`);
                    }
                }

                // 当模态框显示时，保存所有元器件
                searchInput.closest('.modal').addEventListener('show.bs.modal', function() {
                    // 如果是新建项目模态框，清除之前的状态
                    if (listContainer.closest('#addProjectModal')) {
                        componentStates.clear();
                    }
                    
                    // 初始化元器件列表
                    initializeAllComponents();
                    // 初始化状态
                    saveComponentStates();
                });

                // 监听元器件加载完成事件
                document.addEventListener('componentsLoaded', function(e) {
                    // 检查是否是当前容器的元器件加载完成
                    if (e.detail.container && listContainer.contains(e.detail.container)) {
                        initializeAllComponents();
                    }
                });

                // 应用元器件状态
                function applyComponentStates(container) {
                    container.querySelectorAll('.component-item').forEach(item => {
                        const checkbox = item.querySelector('.component-checkbox');
                        if (checkbox) {
                            const state = componentStates.get(checkbox.value);
                            if (state) {
                                checkbox.checked = state.checked;
                                const quantityInput = item.querySelector('.quantity-input');
                                if (quantityInput) {
                                    quantityInput.style.display = state.displayQuantity;
                                    const numberInput = quantityInput.querySelector('input');
                                    if (numberInput) {
                                        numberInput.value = state.quantity;
                                    }
                                }
                            }
                        }
                    });
                }

                // 渲染元器件列表
                function renderComponents(components) {
                    const row = listContainer.querySelector('.row');
                    row.innerHTML = '';

                    if (components.length > 0) {
                        components.forEach(component => {
                            row.appendChild(component.element.cloneNode(true));
                        });

                        // 应用保存的状态 - 但新建项目时不应用任何状态
                        if (!listContainer.closest('#addProjectModal')) {
                        applyComponentStates(row);
                        }

                        // 重新绑定事件监听器
                        row.querySelectorAll('.component-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                const quantityInput = this.closest('.component-item').querySelector('.quantity-input');
                                if (quantityInput) {
                                    quantityInput.style.display = this.checked ? 'block' : 'none';
                                }
                                // 保存新状态
                                saveComponentStates();
                                updateSelectedCount(listContainer);
                            });
                        });

                        // 重新绑定数量输入框事件
                        row.querySelectorAll('.quantity-input input').forEach(input => {
                            input.addEventListener('change', function() {
                                const value = parseInt(this.value) || 1;
                                this.value = Math.max(1, value);
                                // 保存新状态
                                saveComponentStates();
                            });
                        });

                        // 更新选中计数
                        updateSelectedCount(listContainer);
                    } else {
                        const noResults = document.createElement('div');
                        noResults.className = 'col-12 text-center py-4';
                        noResults.innerHTML = '<p class="text-muted">未找到匹配的元器件</p>';
                        row.appendChild(noResults);
                    }
                }

                // 更新选中计数
                function updateSelectedCount(container) {
                    const modalId = container.closest('.modal').id;
                    const countElement = document.getElementById(
                        modalId === 'addProjectModal' ? 'selectedComponentCount' : 'editSelectedComponentCount'
                    );
                    if (countElement) {
                        const checkedCount = container.querySelectorAll('.component-checkbox:checked').length;
                        countElement.textContent = checkedCount;
                    }
                }

                // 搜索事件处理
                searchInput.addEventListener('input', function(e) {
                    // 在搜索之前保存当前状态
                    saveComponentStates();
                    
                    const searchText = e.target.value.toLowerCase().trim();
                    
                    // 如果allComponents为空，尝试从当前DOM中获取元器件
                    if (allComponents.length === 0) {
                        const row = listContainer.querySelector('.row');
                        if (row) {
                            allComponents = Array.from(row.querySelectorAll('.component-item')).map(item => {
                                const col = document.createElement('div');
                                col.className = 'col-md-4';
                                col.appendChild(item.cloneNode(true));
                                return {
                                    element: col,
                                    text: item.textContent.toLowerCase(),
                                    id: item.querySelector('.component-checkbox').value
                                };
                            });
                        }
                    }
                    
                    const filteredComponents = searchText ? 
                        allComponents.filter(item => item.text.includes(searchText)) : 
                        allComponents;
                    
                    // 渲染前确保 componentStates 包含所有选中项
                    const currentStates = new Map(componentStates);
                    currentStates.forEach((state, id) => {
                        if (state.checked) {
                            componentStates.set(id, state);
                        }
                    });
                    
                    renderComponents(filteredComponents);
                });

                // 搜索框清空事件处理
                searchInput.addEventListener('search', function() {
                    if (this.value === '') {
                        renderComponents(allComponents);
                    }
                });
            }

            // 只初始化编辑项目模态框的搜索 (新建项目的搜索已经单独实现)
            handleComponentSearch(
                document.getElementById('editComponentSearch'),
                document.querySelector('#editProjectModal .components-list')
            );
        });

        // 加载项目文件列表
        async function loadProjectFiles(projectId) {
            // 设置当前项目ID，供下载功能使用
            window.currentDownloadProjectId = projectId;
            
            const fileTreeContainer = document.getElementById('downloadFileTree');
            const projectNameElement = document.getElementById('downloadProjectName');
            const downloadStatsElement = document.getElementById('downloadStats');
            const downloadBtn = document.getElementById('downloadBtn');

            // 显示加载状态
            fileTreeContainer.innerHTML = `
                <div class="file-tree-loading">
                    <div class="d-flex justify-content-center align-items-center">
                        <div class="spinner-border text-primary me-2" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <span>正在加载文件列表...</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`/api/project/${projectId}/files`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '获取文件列表失败');
                }

                // 更新项目名称
                projectNameElement.textContent = data.project_name;

                // 构建文件树
                const fileTree = buildFileTreeHTML(data.tree);
                fileTreeContainer.innerHTML = fileTree;

                // 统计文件和文件夹数量
                const stats = countFilesAndFolders(data.tree);
                document.getElementById('totalFolders').textContent = stats.folders;
                document.getElementById('totalFiles').textContent = stats.files;
                document.getElementById('totalSize').textContent = formatFileSize(stats.totalSize);
                downloadStatsElement.style.display = 'block';

                // 添加事件监听器
                addFileTreeEventListeners();

            } catch (error) {
                console.error('Error loading project files:', error);
                fileTreeContainer.innerHTML = `
                    <div class="file-tree-empty">
                        <i class="fas fa-exclamation-triangle text-warning mb-2" style="font-size: 2rem;"></i>
                        <div>加载失败: ${error.message}</div>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadProjectFiles(${projectId})">
                            <i class="fas fa-redo"></i> 重新加载
                        </button>
                    </div>
                `;
                downloadStatsElement.style.display = 'none';
                downloadBtn.disabled = true;
            }
        }

        // 构建文件树HTML
        function buildFileTreeHTML(tree) {
            if (!tree || (tree.folders.length === 0 && tree.files.length === 0)) {
                return `
                    <div class="file-tree-empty">
                        <i class="fas fa-folder-open text-muted mb-2" style="font-size: 2rem;"></i>
                        <div>该项目暂无上传文件</div>
                    </div>
                `;
            }

            let html = '';

            // 渲染文件夹
            tree.folders.forEach(folder => {
                const fileCount = countFilesAndFolders(folder.children);
                html += `
                    <div class="file-tree-item folder" data-path="${folder.path}">
                        <div class="file-tree-item-content">
                            <div class="file-tree-toggle">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="file-tree-icon folder">
                                <i class="fas fa-folder"></i>
                            </div>
                            <div class="file-tree-name">${folder.name}</div>
                            <div class="file-count-badge">${fileCount.files} 文件</div>
                            <div class="file-tree-checkbox">
                                <input type="checkbox" class="form-check-input" data-type="folder">
                            </div>
                        </div>
                        <div class="file-tree-children">
                            ${buildFileTreeHTML(folder.children)}
                        </div>
                    </div>
                `;
            });

            // 渲染文件
            tree.files.forEach(file => {
                const iconClass = getFileIcon(file.extension);
                html += `
                    <div class="file-tree-item file" data-path="${file.path}">
                        <div class="file-tree-item-content">
                            <div class="file-tree-toggle"></div>
                            <div class="file-tree-icon file ${file.extension.slice(1)}">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="file-tree-name">${file.name}</div>
                            <div class="file-tree-size">${file.size_formatted}</div>
                            <div class="file-tree-checkbox">
                                <input type="checkbox" class="form-check-input" data-type="file" data-size="${file.size}">
                            </div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        // 获取文件图标
        function getFileIcon(extension) {
            const iconMap = {
                '.pdf': 'fa-file-pdf',
                '.doc': 'fa-file-word',
                '.docx': 'fa-file-word',
                '.xls': 'fa-file-excel',
                '.xlsx': 'fa-file-excel',
                '.ppt': 'fa-file-powerpoint',
                '.pptx': 'fa-file-powerpoint',
                '.jpg': 'fa-file-image',
                '.jpeg': 'fa-file-image',
                '.png': 'fa-file-image',
                '.gif': 'fa-file-image',
                '.svg': 'fa-file-image',
                '.mp4': 'fa-file-video',
                '.avi': 'fa-file-video',
                '.mov': 'fa-file-video',
                '.mp3': 'fa-file-audio',
                '.wav': 'fa-file-audio',
                '.txt': 'fa-file-alt',
                '.zip': 'fa-file-archive',
                '.rar': 'fa-file-archive',
                '.7z': 'fa-file-archive',
                '.html': 'fa-file-code',
                '.css': 'fa-file-code',
                '.js': 'fa-file-code',
                '.py': 'fa-file-code',
                '.java': 'fa-file-code',
                '.cpp': 'fa-file-code',
                '.c': 'fa-file-code'
            };
            return iconMap[extension] || 'fa-file';
        }

        // 统计文件和文件夹数量
        function countFilesAndFolders(tree) {
            let folders = 0;
            let files = 0;
            let totalSize = 0;

            if (tree.folders) {
                folders += tree.folders.length;
                tree.folders.forEach(folder => {
                    const childStats = countFilesAndFolders(folder.children);
                    folders += childStats.folders;
                    files += childStats.files;
                    totalSize += childStats.totalSize;
                });
            }

            if (tree.files) {
                files += tree.files.length;
                tree.files.forEach(file => {
                    totalSize += file.size;
                });
            }

            return { folders, files, totalSize };
        }

        // 添加文件树事件监听器
        function addFileTreeEventListeners() {
            // 文件夹展开/收起
            document.querySelectorAll('.file-tree-toggle').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const item = this.closest('.file-tree-item');
                    const children = item.querySelector('.file-tree-children');
                    const icon = this.querySelector('i');

                    if (children) {
                        const isExpanded = children.classList.contains('expanded');
                        if (isExpanded) {
                            children.classList.remove('expanded');
                            this.classList.remove('expanded');
                        } else {
                            children.classList.add('expanded');
                            this.classList.add('expanded');
                        }
                    }
                });
            });

            // 复选框事件
            document.querySelectorAll('.file-tree-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateDownloadButtons();
                    updateParentCheckboxes(this);
                    updateChildCheckboxes(this);
                });
            });
        }

        // 更新下载按钮状态
        function updateDownloadButtons() {
            const selectedCheckboxes = document.querySelectorAll('.file-tree-checkbox input:checked');
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadBtnText = document.getElementById('downloadBtnText');
            
            if (selectedCheckboxes.length === 0) {
                downloadBtn.disabled = true;
                downloadBtnText.textContent = '选择要下载的文件';
            } else if (selectedCheckboxes.length === 1) {
                // 检查是否为单个文件
                const selectedItem = selectedCheckboxes[0].closest('.file-tree-item');
                if (selectedItem.classList.contains('file')) {
                    downloadBtn.disabled = false;
                    downloadBtnText.textContent = '下载文件';
                } else {
                    downloadBtn.disabled = false;
                    downloadBtnText.textContent = '下载压缩包';
                }
            } else {
                downloadBtn.disabled = false;
                downloadBtnText.textContent = `下载压缩包 (${selectedCheckboxes.length}项)`;
            }
        }

        // 更新父级复选框状态
        function updateParentCheckboxes(checkbox) {
            const item = checkbox.closest('.file-tree-item');
            const parentItem = item.parentElement.closest('.file-tree-item');
            
            if (parentItem && parentItem.classList.contains('folder')) {
                const parentCheckbox = parentItem.querySelector('.file-tree-checkbox input');
                const childrenContainer = parentItem.querySelector('.file-tree-children');
                const childCheckboxes = childrenContainer.querySelectorAll('.file-tree-checkbox input');
                const checkedChildren = childrenContainer.querySelectorAll('.file-tree-checkbox input:checked');
                
                if (checkedChildren.length === 0) {
                    parentCheckbox.checked = false;
                    parentCheckbox.indeterminate = false;
                } else if (checkedChildren.length === childCheckboxes.length) {
                    parentCheckbox.checked = true;
                    parentCheckbox.indeterminate = false;
                } else {
                    parentCheckbox.checked = false;
                    parentCheckbox.indeterminate = true;
                }
                
                updateParentCheckboxes(parentCheckbox);
            }
        }

        // 更新子级复选框状态
        function updateChildCheckboxes(checkbox) {
            const item = checkbox.closest('.file-tree-item');
            if (item.classList.contains('folder')) {
                const childrenContainer = item.querySelector('.file-tree-children');
                const childCheckboxes = childrenContainer.querySelectorAll('.file-tree-checkbox input');
                
                childCheckboxes.forEach(childCheckbox => {
                    childCheckbox.checked = checkbox.checked;
                    updateChildCheckboxes(childCheckbox);
                });
            }
        }

        // 展开所有文件夹
        function expandAllFolders() {
            document.querySelectorAll('.file-tree-children').forEach(children => {
                children.classList.add('expanded');
            });
            document.querySelectorAll('.file-tree-toggle').forEach(toggle => {
                toggle.classList.add('expanded');
            });
        }

        // 收起所有文件夹
        function collapseAllFolders() {
            document.querySelectorAll('.file-tree-children').forEach(children => {
                children.classList.remove('expanded');
            });
            document.querySelectorAll('.file-tree-toggle').forEach(toggle => {
                toggle.classList.remove('expanded');
            });
        }

        // 处理下载逻辑
        function handleDownload() {
            const selectedCheckboxes = document.querySelectorAll('.file-tree-checkbox input:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('请选择要下载的文件或文件夹');
                return;
            }
            
            // 收集选中的文件/文件夹路径
            const selectedPaths = Array.from(selectedCheckboxes).map(checkbox => {
                const item = checkbox.closest('.file-tree-item');
                return item.dataset.path;
            });
            
            // 获取当前项目ID
            const projectId = getCurrentProjectId();
            
            if (selectedCheckboxes.length === 1) {
                const selectedItem = selectedCheckboxes[0].closest('.file-tree-item');
                if (selectedItem.classList.contains('file')) {
                    // 单个文件直接下载
                    downloadSingleFile(projectId, selectedPaths[0]);
                } else {
                    // 单个文件夹压缩下载
                    downloadAsZip(projectId, selectedPaths);
                }
            } else {
                // 多个文件/文件夹压缩下载
                downloadAsZip(projectId, selectedPaths);
            }
        }
        
        // 下载单个文件
        function downloadSingleFile(projectId, filePath) {
            const downloadUrl = `/api/project/${projectId}/download/file?path=${encodeURIComponent(filePath)}`;
            window.open(downloadUrl, '_blank');
        }
        
        // 下载压缩包
        function downloadAsZip(projectId, filePaths) {
            const downloadUrl = `/api/project/${projectId}/download/zip`;
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = downloadUrl;
            form.target = '_blank';
            
            filePaths.forEach(path => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'paths[]';
                input.value = path;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
        
        // 获取当前项目ID
        function getCurrentProjectId() {
            // 这个函数需要在loadProjectFiles中设置项目ID
            return window.currentDownloadProjectId;
        }

        // 页面加载完成后绑定下载按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('downloadBtn').addEventListener('click', handleDownload);
        });

        // 分享项目相关功能
        let currentShareProjectId = null;

        function shareProject(jobId) {
            console.log('=== 开始分享项目 ===');
            console.log('项目ID:', jobId);
            currentShareProjectId = jobId;
            
            // 获取项目信息
            const project = getProjectById(jobId);
            if (!project) {
                showToast('错误', '无法找到项目信息');
                return;
            }
            
            console.log('项目信息:', project);
            
            // 设置项目名称
            document.getElementById('shareProjectName').textContent = project.name;
            
            // 检查是否已经有分享
            console.log('开始检查现有分享状态...');
            checkExistingShare(jobId);
            
            // 显示分享模态框
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            shareModal.show();
        }

        // 获取项目信息
        function getProjectById(jobId) {
            const tbody = document.querySelector('.table tbody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                // 尝试查找任何包含jobId的按钮，而不只是编辑按钮
                const buttons = row.querySelectorAll('.dropdown-item');
                for (let button of buttons) {
                    const onclick = button.getAttribute('onclick');
                    if (onclick && onclick.includes(jobId)) {
                        return {
                            id: jobId,
                            name: row.querySelector('.col-name span').textContent.trim()
                        };
                    }
                }
            }
            return null;
        }

        // 检查现有分享
        function checkExistingShare(projectId) {
            // 添加时间戳和缓存控制，防止浏览器缓存旧数据
            const timestamp = new Date().getTime();
            fetch(`/api/project/${projectId}/share?_t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log('分享状态检查结果:', data);
                    if (data.shared) {
                        // 已经存在分享，显示分享信息
                        showExistingShare(data);
                    } else {
                        // 没有分享，显示创建界面
                        showCreateShare();
                    }
                })
                .catch(error => {
                    console.error('Error checking share:', error);
                    showCreateShare();
                });
        }

        // 显示现有分享信息
        function showExistingShare(shareData) {
            document.getElementById('shareSettings').style.display = 'none';
            document.getElementById('shareResult').style.display = 'block';
            document.getElementById('createShareBtn').style.display = 'none';
            document.getElementById('cancelShareBtn').style.display = 'block';

            // 设置分享链接
            const fullUrl = window.location.origin + shareData.share_url;
            document.getElementById('shareUrl').value = fullUrl;

            // 设置过期信息
            const expireInfo = document.getElementById('shareExpireInfo');
            if (shareData.expire_time) {
                const expireDate = new Date(shareData.expire_time);
                expireInfo.textContent = `过期时间：${expireDate.toLocaleString()}`;
            } else {
                expireInfo.textContent = '过期时间：永不过期';
            }

            // 设置密码信息
            const passwordInfo = document.getElementById('sharePasswordInfo');
            passwordInfo.textContent = shareData.has_password ? '访问需要密码' : '无需密码访问';

            // 设置访问信息
            const accessInfo = document.getElementById('shareAccessInfo');
            const createdDate = new Date(shareData.created_at);
            const accessCount = shareData.access_count || 0;  // 确保访问次数不为undefined
            let accessText = `创建时间：${createdDate.toLocaleString()}，访问次数：${accessCount}`;
            
            // 添加访问次数限制信息
            if (shareData.max_access_count && shareData.max_access_count > 0) {
                accessText += ` / ${shareData.max_access_count}`;
            } else {
                accessText += ' (无限制)';
            }
            
            accessInfo.textContent = accessText;
        }

        // 显示创建分享界面
        function showCreateShare() {
            document.getElementById('shareSettings').style.display = 'block';
            document.getElementById('shareResult').style.display = 'none';
            document.getElementById('createShareBtn').style.display = 'block';
            document.getElementById('cancelShareBtn').style.display = 'none';

            // 重置表单
            document.getElementById('shareForm').reset();
            document.querySelector('[name="expire_hours"]').value = '24';
        }

        // 创建分享 - 确保DOM加载完成后绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，开始绑定分享事件');
            
            console.log('准备绑定创建分享按钮事件');
            const createShareBtn = document.getElementById('createShareBtn');
            console.log('createShareBtn元素:', createShareBtn);
            
            if (!createShareBtn) {
                console.error('找不到createShareBtn按钮元素！');
                return;
            }
            
            createShareBtn.addEventListener('click', function() {
                console.log('创建分享按钮被点击');
                console.log('currentShareProjectId:', currentShareProjectId);
                
                const form = document.getElementById('shareForm');
                console.log('表单元素:', form);
                console.log('表单有效性:', form ? form.checkValidity() : 'form not found');
                
                if (!form.checkValidity()) {
                    console.log('表单验证失败');
                    form.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(form);
                const shareData = {
                    expire_hours: parseInt(formData.get('expire_hours')),
                    password: formData.get('password'),
                    max_access_count: parseInt(formData.get('max_access_count'))
                };
                
                console.log('分享数据:', shareData);

                // 显示加载状态
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 创建中...';

                console.log('发送API请求...');
                fetch(`/api/project/${currentShareProjectId}/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(shareData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('分享创建API响应:', data);
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // 构造要传递给showExistingShare的数据
                    const shareDisplayData = {
                        share_url: data.share_url,
                        expire_time: data.expire_time,
                        max_access_count: data.max_access_count,
                        has_password: data.has_password,
                        access_count: 0,
                        created_at: new Date().toISOString()
                    };
                    
                    console.log('准备显示分享结果，数据:', shareDisplayData);

                    // 显示成功结果
                    showExistingShare(shareDisplayData);

                    showToast('分享创建成功', '项目分享链接已生成！', 'success');
                    
                    // 刷新项目行的显示，更新分享状态图标
                    refreshProjectRow(currentShareProjectId);
                    
                    console.log('分享创建流程完成');
                })
                .catch(error => {
                    console.error('Error creating share:', error);
                    showToast('分享创建失败', '❌ ' + (error.message || '无法创建分享链接，请检查网络连接后重试'), 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-share-alt"></i> 创建分享';
                });
            });

            // 取消分享
            const cancelShareBtn = document.getElementById('cancelShareBtn');
            if (cancelShareBtn) {
                cancelShareBtn.addEventListener('click', function() {
                    // 显示加载状态
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 取消中...';

                    fetch(`/api/project/${currentShareProjectId}/share`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        // 显示创建界面
                        showCreateShare();
                        showToast('分享已取消', '分享链接已成功取消，所有外部访问已停止。', 'success');
                        
                        // 刷新项目行的显示，更新分享状态图标
                        refreshProjectRow(currentShareProjectId);
                    })
                    .catch(error => {
                        console.error('Error canceling share:', error);
                        showToast('取消失败', (error.message || '无法取消分享，请检查网络连接后重试'), 'error');
                    })
                    .finally(() => {
                        // 恢复按钮状态
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-times"></i> 取消分享';
                    });
                });
            }

            // 重置分享模态框
            const shareModal = document.getElementById('shareModal');
            if (shareModal) {
                shareModal.addEventListener('hidden.bs.modal', function () {
                    console.log('=== 分享模态框即将关闭 ===');
                    console.log('当前项目ID:', currentShareProjectId);
                    
                    // 如果有当前项目ID，刷新项目行显示
                    if (currentShareProjectId) {
                        refreshProjectRow(currentShareProjectId);
                    }
                    
                    // 清除状态，确保下次打开时重新检查
                    const oldProjectId = currentShareProjectId;
                    currentShareProjectId = null;
                    showCreateShare();
                    const shareForm = document.getElementById('shareForm');
                    if (shareForm) {
                        shareForm.classList.remove('was-validated');
                    }
                    
                    console.log('分享模态框已关闭，状态已重置，项目ID从', oldProjectId, '重置为', currentShareProjectId);
                });
            }
            
            console.log('分享事件绑定完成');
        });

        // 复制分享链接
        function copyShareUrl() {
            const shareUrlInput = document.getElementById('shareUrl');
            shareUrlInput.select();
            shareUrlInput.setSelectionRange(0, 99999); // 移动设备兼容性

            try {
                document.execCommand('copy');
                showToast('链接已复制', '分享链接已复制到剪贴板。', 'success');
            } catch (err) {
                console.error('Failed to copy: ', err);
                showToast('复制失败', '请手动选择并复制链接', 'warning');
            }
        }

        function downloadProject(jobId) {
            loadProjectFiles(jobId);
        }

        function collaborateProject(jobId) {
            // 打开项目协作管理模态框
            currentProjectId = jobId;
            
            // 获取项目信息并更新模态框标题
            const projectRow = document.querySelector(`tr[data-project-id="${jobId}"]`);
            if (projectRow) {
                const projectName = projectRow.querySelector('[data-field="name"]').textContent;
                document.getElementById('collaborateProjectName').textContent = projectName;
            }
            
            // 加载可用的协作者
            loadAvailableCollaborators();
            
            // 加载现有协作者
            loadProjectCollaborations(jobId);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('collaborateModal'));
            modal.show();
        }

        // 自定义确认对话框
        function showConfirm(options) {
            return new Promise((resolve) => {
                const {
                    title = '确认操作',
                    message = '您确定要执行此操作吗？',
                    note = '此操作无法撤销，请谨慎操作。',
                    confirmText = '确认',
                    cancelText = '取消',
                    confirmClass = 'btn-danger',
                    icon = 'fas fa-exclamation-triangle text-warning'
                } = options;

                // 设置对话框内容
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmNote').textContent = note;
                
                const confirmBtn = document.getElementById('confirmOkBtn');
                confirmBtn.innerHTML = `<i class="fas fa-check me-1"></i>${confirmText}`;
                confirmBtn.className = `btn ${confirmClass}`;
                
                // 设置图标
                const titleIcon = document.querySelector('#confirmModalLabel i');
                titleIcon.className = icon;

                // 显示对话框
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                confirmModal.show();

                // 处理确认按钮点击
                const handleConfirm = () => {
                    confirmModal.hide();
                    confirmBtn.removeEventListener('click', handleConfirm);
                    resolve(true);
                };

                // 处理取消或关闭
                const handleCancel = () => {
                    confirmModal.hide();
                    document.getElementById('confirmModal').removeEventListener('hidden.bs.modal', handleCancel);
                    confirmBtn.removeEventListener('click', handleConfirm);
                    resolve(false);
                };

                // 绑定事件
                confirmBtn.addEventListener('click', handleConfirm);
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', handleCancel, { once: true });
            });
        }
    </script>

    <!-- 添加元件详情模态框 -->
    <div class="modal fade" id="componentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">元件列表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>名称</th>
                                    <th>型号</th>
                                    <th>单价</th>
                                    <th>数量</th>
                                    <th>总价</th>
                                </tr>
                            </thead>
                            <tbody id="componentsTableBody">
                            </tbody>
                            <tfoot>
                                <tr class="components-total-row">
                                    <td colspan="5" class="text-end fw-bold">所有元件总价：</td>
                                    <td class="fw-bold components-total-price" id="totalComponentsPrice">¥0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加要求详情模态框 -->
    <div class="modal fade" id="requirementsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">项目要求</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="requirementsList" class="list-group">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载文件模态框 -->
    <div class="modal fade" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadModalLabel">
                        <i class="fas fa-download me-2"></i>下载项目文件
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 class="mb-0">项目：<span id="downloadProjectName" class="text-primary"></span></h6>
                    </div>
                    
                    <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                        <div id="downloadFileTree" class="file-tree">
                            <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <span class="ms-2">正在加载文件列表...</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3" id="downloadStats" style="display: none;">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            总计：<span id="totalFolders">0</span> 个文件夹，<span id="totalFiles">0</span> 个文件，总大小：<span id="totalSize">0 B</span>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="downloadBtn" disabled>
                        <i class="fas fa-download"></i> <span id="downloadBtnText">下载文件</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件上传模态框 -->
    {% include 'upload_modal.html' %}

    <!-- 分享设置模态框 -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">
                        <i class="fas fa-share-alt me-2"></i>分享项目
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="shareSettings">
                        <form id="shareForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <h6 class="mb-0">项目：<span id="shareProjectName" class="text-primary"></span></h6>
                            </div>
                            
                            <!-- 过期时间设置 -->
                            <div class="mb-3">
                                <label class="form-label">分享有效期</label>
                                <select class="form-select" name="expire_hours" required>
                                    <option value="1">1小时</option>
                                    <option value="6">6小时</option>
                                    <option value="24" selected>24小时</option>
                                    <option value="72">3天</option>
                                    <option value="168">7天</option>
                                    <option value="720">30天</option>
                                    <option value="-1">永不过期</option>
                                </select>
                            </div>

                            <!-- 密码设置 -->
                            <div class="mb-3">
                                <label class="form-label">访问密码</label>
                                <input type="password" class="form-control" name="password" placeholder="留空表示无需密码">
                                <small class="text-muted">设置密码可以增加分享安全性</small>
                            </div>

                            <!-- 访问次数限制 -->
                            <div class="mb-3">
                                <label class="form-label">访问次数限制</label>
                                <select class="form-select" name="max_access_count">
                                    <option value="-1" selected>无限制</option>
                                    <option value="1">1次</option>
                                    <option value="3">3次</option>
                                    <option value="5">5次</option>
                                    <option value="10">10次</option>
                                    <option value="20">20次</option>
                                    <option value="50">50次</option>
                                    <option value="100">100次</option>
                                </select>
                                <small class="text-muted">限制分享链接的总访问次数</small>
                            </div>

                            <!-- 提示信息 -->
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                创建分享后，任何拥有链接的人都可以访问并下载项目文件。
                            </div>
                        </form>
                    </div>

                    <!-- 分享结果显示 -->
                    <div id="shareResult" style="display: none;">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> 分享链接已创建</h6>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="shareUrl" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyShareUrl()">
                                    <i class="fas fa-copy"></i> 复制
                                </button>
                            </div>
                            <small class="text-muted">
                                <div id="shareExpireInfo"></div>
                                <div id="sharePasswordInfo"></div>
                                <div id="shareAccessInfo"></div>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="createShareBtn">
                        <i class="fas fa-share-alt"></i> 创建分享
                    </button>
                    <button type="button" class="btn btn-danger" id="cancelShareBtn" style="display: none;">
                        <i class="fas fa-times"></i> 取消分享
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

<!-- 自定义确认对话框 -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title d-flex align-items-center" id="confirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <span id="confirmTitle">确认操作</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <p class="mb-0" id="confirmMessage">您确定要执行此操作吗？</p>
                <div class="mt-3 p-3 bg-light rounded">
                    <small class="text-muted" id="confirmNote">此操作无法撤销，请谨慎操作。</small>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-danger" id="confirmOkBtn">
                    <i class="fas fa-check me-1"></i>确认
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 项目协作模态框 -->
<div class="modal fade" id="collaborateModal" tabindex="-1" aria-labelledby="collaborateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <!-- 模态框头部 - 使用渐变背景 -->
            <div class="modal-header position-relative" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem;">
                <div class="d-flex align-items-center">
                    <div class="collaboration-icon-wrapper me-3">
                        <i class="fas fa-users" style="font-size: 2rem; opacity: 0.9;"></i>
                    </div>
                    <div>
                        <h4 class="modal-title mb-1" id="collaborateModalLabel" style="font-weight: 600;">
                            项目协作管理
                        </h4>
                        <p class="mb-0" style="opacity: 0.9; font-size: 0.95rem;">
                            邀请团队成员一起协作完成项目
                        </p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                
                <!-- 装饰性元素 -->
                <div class="position-absolute" style="top: -50px; right: -50px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                <div class="position-absolute" style="bottom: -30px; left: -30px; width: 60px; height: 60px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
            </div>
            
            <div class="modal-body p-0">
                <!-- 项目信息栏 -->
                <div class="project-info-bar px-4 py-3" style="background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6;">
                    <div class="d-flex align-items-center">
                        <div class="project-icon me-3">
                            <i class="fas fa-project-diagram text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h6 class="mb-1 text-dark">当前项目</h6>
                            <span id="collaborateProjectName" class="text-primary fw-bold" style="font-size: 1.1rem;"></span>
                        </div>
                    </div>
                </div>

                <div class="container-fluid p-4">
                    <!-- 添加协作者区域 -->
                    <div class="collaboration-section mb-4">
                        <div class="section-card" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); border: 1px solid #667eea30; border-radius: 15px; overflow: hidden;">
                            <div class="card-header-custom px-4 py-3" style="background: rgba(102, 126, 234, 0.1); border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                                <div class="d-flex align-items-center">
                                    <div class="icon-wrapper me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user-plus text-white"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 text-dark fw-bold">添加新协作者</h6>
                                        <small class="text-muted">邀请团队成员参与项目协作</small>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body-custom p-4">
                                <form id="addCollaboratorForm" class="needs-validation" novalidate>
                                    <div class="row g-4">
                                        <div class="col-md-5">
                                            <label class="form-label fw-semibold text-dark mb-2">
                                                <i class="fas fa-user me-2 text-primary"></i>选择用户
                                            </label>
                                            <select class="form-select form-select-lg" name="collaborator_id" required style="border-radius: 10px; border: 2px solid #e9ecef; transition: all 0.3s;">
                                                <option value="">请选择用户</option>
                                            </select>
                                            <div class="invalid-feedback">请选择要添加的用户</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold text-dark mb-2">
                                                <i class="fas fa-shield-alt me-2 text-success"></i>权限级别
                                            </label>
                                            <select class="form-select form-select-lg" name="permission" required style="border-radius: 10px; border: 2px solid #e9ecef; transition: all 0.3s;">
                                                <option value="read">
                                                    <i class="fas fa-eye"></i> 只读权限
                                                </option>
                                                <option value="write">
                                                    <i class="fas fa-edit"></i> 读写权限
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button type="submit" class="btn btn-primary btn-lg w-100" style="border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                                <i class="fas fa-plus me-2"></i>邀请加入
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 协作者列表 -->
                    <div class="collaboration-section">
                        <div class="section-card" style="background: white; border: 1px solid #e9ecef; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                            <div class="card-header-custom px-4 py-3" style="background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6;">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-wrapper me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-users text-white"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 text-dark fw-bold">当前协作者</h6>
                                            <small class="text-muted">管理项目协作成员和权限</small>
                                        </div>
                                    </div>
                                    <div class="collaborators-count-badge">
                                        <span class="badge" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); font-size: 0.85rem; padding: 0.5rem 1rem; border-radius: 20px;">
                                            <i class="fas fa-users me-1"></i>
                                            <span id="collaboratorsCount">0</span> 名协作者
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body-custom" style="max-height: 400px; overflow-y: auto;">
                                <div id="collaboratorsList">
                                    <div class="d-flex justify-content-center align-items-center py-5">
                                        <div class="text-center">
                                            <div class="spinner-wrapper mb-3">
                                                <div class="spinner-border" style="color: #667eea;" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                            </div>
                                            <span class="text-muted">正在加载协作者列表...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer px-4 py-3" style="background: #f8f9fa; border-top: 1px solid #dee2e6;">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="collaboration-tips">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            提示：协作者可以查看和编辑项目内容
                        </small>
                    </div>
                    <button type="button" class="btn btn-secondary btn-lg px-4" data-bs-dismiss="modal" style="border-radius: 10px;">
                        <i class="fas fa-times me-2"></i>关闭
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 协作模态框专用样式 */
#collaborateModal .form-select:focus,
#collaborateModal .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

#collaborateModal .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

#collaborateModal .collaborator-item {
    transition: all 0.3s ease;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 0.5rem;
}

#collaborateModal .collaborator-item:hover {
    /* 注释掉模糊和移动效果 */
    /* background: rgba(102, 126, 234, 0.05); */
    /* transform: translateX(5px); */
}

#collaborateModal .permission-badge {
    transition: all 0.3s ease;
}

#collaborateModal .permission-badge.read {
    background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
}

#collaborateModal .permission-badge.write {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

#collaborateModal .action-btn {
    transition: all 0.3s ease;
    border-radius: 8px;
    border: none;
    padding: 0.5rem;
    margin: 0 0.2rem;
}

#collaborateModal .action-btn:hover {
    transform: translateY(-2px);
}

#collaborateModal .remove-btn {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
}

#collaborateModal .remove-btn:hover {
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

/* 加载动画 */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

#collaborateModal .loading-pulse {
    animation: pulse 2s infinite;
}
</style>

<script>
// 获取并更新元器件总价格
async function updateComponentsPrice() {
    try {
        const response = await fetch('/api/user/stats');
        const stats = await response.json();
        if (response.ok) {
            updatePriceDisplay('#components-price', stats.components_total_price);
        }
    } catch (error) {
        console.error('Failed to update components price:', error);
    }
}

// 检查统计数据是否需要更新
async function checkStatsUpdate() {
    try {
        const response = await fetch('/api/stats-update-check');
        const data = await response.json();
        
        if (response.ok && data.needs_update) {
            console.log('统计数据需要更新，正在刷新...');
            await updateComponentsPrice();
            await updateStatsCards();
        }
    } catch (error) {
        console.error('检查统计数据更新失败:', error);
    }
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    updateComponentsPrice();
    initializePriceToggle();
    
    // 每30秒检查一次统计数据是否需要更新
    setInterval(checkStatsUpdate, 30000);
});

// 初始化价格切换功能
async function initializePriceToggle() {
    try {
        // 获取用户设置
        const response = await fetch('/api/user/settings');
        const settings = await response.json();
        
        if (response.ok) {
            const hidePrices = settings.hide_prices;
            updatePriceVisibility(hidePrices);
        }
    } catch (error) {
        console.error('Failed to load user settings:', error);
    }
    
    // 绑定切换按钮事件
    const toggleBtn = document.getElementById('togglePriceBtn');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', togglePriceVisibility);
    }
}

// 切换价格显示/隐藏
async function togglePriceVisibility() {
    const priceElements = document.querySelectorAll('.price-value');
    const isCurrentlyHidden = priceElements[0].querySelector('.price-visible').style.display === 'none';
    const newHideState = !isCurrentlyHidden;
    
    try {
        // 更新服务器设置
        const response = await fetch('/api/user/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hide_prices: newHideState
            })
        });
        
        if (response.ok) {
            updatePriceVisibility(newHideState);
        } else {
            console.error('Failed to update price visibility setting');
        }
    } catch (error) {
        console.error('Error updating price visibility:', error);
    }
}

// 更新价格显示状态
function updatePriceVisibility(hidePrices) {
    const priceElements = document.querySelectorAll('.price-value');
    const toggleBtn = document.getElementById('togglePriceBtn');
    const toggleIcon = document.getElementById('togglePriceIcon');
    const toggleText = document.getElementById('togglePriceText');
    
    priceElements.forEach(element => {
        const visibleSpan = element.querySelector('.price-visible');
        const hiddenSpan = element.querySelector('.price-hidden');
        
        if (hidePrices) {
            visibleSpan.style.display = 'none';
            hiddenSpan.style.display = 'inline';
        } else {
            visibleSpan.style.display = 'inline';
            hiddenSpan.style.display = 'none';
        }
    });
    
    // 更新按钮状态
    if (toggleBtn) {
        if (hidePrices) {
            toggleIcon.className = 'fas fa-eye-slash';
            toggleText.textContent = '显示价格';
            toggleBtn.classList.remove('btn-outline-light');
            toggleBtn.classList.add('btn-warning');
        } else {
            toggleIcon.className = 'fas fa-eye';
            toggleText.textContent = '隐藏价格';
            toggleBtn.classList.remove('btn-warning');
            toggleBtn.classList.add('btn-outline-light');
        }
    }
}

// 更新价格显示（用于统计卡片更新时）
function updatePriceDisplay(selector, value) {
    const element = document.querySelector(selector);
    if (element) {
        const visibleSpan = element.querySelector('.price-visible');
        if (visibleSpan) {
            visibleSpan.textContent = '¥' + value.toFixed(2);
        }
    }
}

// 更新所有统计卡片
async function updateStatsCards() {
    try {
        const response = await fetch('/api/user/stats');
        const stats = await response.json();
        
        if (response.ok) {
            // 更新各个统计卡片
            updatePriceDisplay('#total-price', stats.total_price);
            updatePriceDisplay('#incomplete-price', stats.incomplete_price);
            updatePriceDisplay('#components-price', stats.components_total_price);
            
            // 更新项目数量
            const totalProjectsElement = document.querySelector('#total-projects');
            if (totalProjectsElement) {
                totalProjectsElement.textContent = stats.total_projects;
            }
            
            const incompleteProjectsElement = document.querySelector('#incomplete-projects');
            if (incompleteProjectsElement) {
                incompleteProjectsElement.textContent = stats.incomplete_projects;
            }
        }
    } catch (error) {
        console.error('更新统计卡片失败:', error);
    }
}

// 退出协作函数
function leaveCollaboration(projectId) {
    fetch(`/api/project/${projectId}/collaboration/leave`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        // 从表格中移除该行
        const tbody = document.querySelector('.table tbody');
        const row = Array.from(tbody.children).find(row => {
            const leaveButton = row.querySelector('.dropdown-item.leave-collaboration');
            return leaveButton && leaveButton.getAttribute('onclick').includes(projectId);
        });

        if (row) {
            row.remove();
            
            // 更新剩余行的序号
            const projectRows = Array.from(tbody.children).filter(row => !row.classList.contains('no-results-row'));
            projectRows.forEach((row, index) => {
                const indexCell = row.querySelector('.col-index');
                if (indexCell) {
                    indexCell.textContent = index + 1;
                }
            });

            // 更新搜索功能的行引用
            if (window.updateProjectSearchRows) {
                window.updateProjectSearchRows();
            }
        }

        // 更新统计卡片
        updateStatsCards();
        
        // 更新元器件总价格
        if (typeof updateComponentsPrice === 'function') {
            updateComponentsPrice();
        }
        
        // 显示成功消息
        showToast('退出成功', '您已成功退出项目协作');
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('退出失败', error.message || '无法退出项目协作，请重试', 'error');
    });
}

// 防重复提交机制
(function() {
    let isSubmitting = false;
    
    // 重写submitProject按钮的点击处理
    document.addEventListener('DOMContentLoaded', function() {
        const submitBtn = document.getElementById('submitProject');
        if (submitBtn) {
            // 移除所有现有的事件监听器
            const newSubmitBtn = submitBtn.cloneNode(true);
            submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
            
            // 添加单一的事件监听器
            newSubmitBtn.addEventListener('click', function() {
                // 防止重复提交
                if (isSubmitting) {
                    console.log('Preventing duplicate submission');
                    return;
                }
                
                const form = document.getElementById('addProjectForm');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                // 设置提交状态
                isSubmitting = true;
                newSubmitBtn.disabled = true;
                const originalText = newSubmitBtn.textContent;
                newSubmitBtn.textContent = '提交中...';
                
                // 执行提交逻辑
                submitProject(form, newSubmitBtn, originalText);
            });
        }
    });
    
    // 提取的提交逻辑
    function submitProject(form, submitBtn, originalText) {
        // 收集表单数据
        const formData = new FormData(form);
        
        // 获取来源和类型的名称
        const sourceSelect = form.querySelector('[name="source"]');
        const typeSelect = form.querySelector('[name="board_type"]');
        const sourceName = sourceSelect.options[sourceSelect.selectedIndex].text;
        const typeName = typeSelect.options[typeSelect.selectedIndex].text;
        
        // 获取选中的元器件 - 只从新建项目模态框中获取
        const selectedComponents = Array.from(document.querySelectorAll('#addProjectModal .component-checkbox:checked')).map(checkbox => {
            const componentItem = checkbox.closest('.component-item');
            const name = componentItem.querySelector('.component-name').textContent;
            const model = componentItem.querySelector('.component-model').textContent;
            const price = parseFloat(componentItem.querySelector('.component-price').textContent.replace('¥', ''));
            const quantity = parseInt(componentItem.querySelector('.quantity-input input').value);
            return {
                id: parseInt(checkbox.value),
                name: name,
                model: model,
                price: price,
                quantity: quantity
            };
        });

        // 处理要求文本
        const requirementsText = formData.get('requirements');
        const requirements = [];
        if (requirementsText) {
            const requirementMatches = requirementsText.match(/##(.+?)##([^#]+)/g);
            if (requirementMatches) {
                requirementMatches.forEach((match, index) => {
                    const titleMatch = match.match(/##(.+?)##/);
                    const title = titleMatch ? titleMatch[1].trim() : '';
                    const content = match.replace(/##.+?##/, '').trim();
                    if (title && content) {
                        requirements.push({
                            title: title,
                            content: content,
                            color: getRequirementColor(index)
                        });
                    }
                });
            }
        }

        // 构建项目数据
        const projectData = {
            source: sourceName,
            source_id: formData.get('source'),
            name: formData.get('name'),
            price: parseFloat(formData.get('price')),
            board_type: typeName,
            board_type_id: formData.get('board_type'),
            status: formData.get('status'),
            remark: formData.get('remark') || '',
            components: selectedComponents,
            requirements: requirements
        };

        // 发送到服务器
        fetch('/api/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(projectData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // 添加新行到表格
            const tbody = document.querySelector('.table tbody');
            const rowCount = tbody.children.length;
            const newRow = createTableRow(data.project, rowCount + 1);
            tbody.insertAdjacentHTML('beforeend', newRow);

            // 为新添加的行初始化下拉菜单定位
            const lastRow = tbody.lastElementChild;
            if (typeof initializeDropdownPosition === 'function') {
                initializeDropdownPosition(lastRow.querySelector('.dropdown'));
            }

            // 更新搜索功能的行引用
            if (window.updateProjectSearchRows) {
                window.updateProjectSearchRows();
            }

            // 更新统计卡片
            if (typeof updateStatsCards === 'function') {
                updateStatsCards();
            }
            
            // 更新元器件总价格
            if (typeof updateComponentsPrice === 'function') {
                updateComponentsPrice();
            }
            
            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
            modal.hide();
            form.reset();
            form.classList.remove('was-validated');
            
            // 手动重置元器件选择状态
            if (typeof resetComponentsSelection === 'function') {
                resetComponentsSelection();
            }
            
            // 显示成功消息
            if (typeof showToast === 'function') {
                showToast('创建成功', '新项目已成功添加到列表中');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showToast === 'function') {
                showToast('创建失败', error.message || '无法创建新项目，请重试');
            }
        })
        .finally(() => {
            // 恢复按钮状态
            isSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    }
})();

        // 刷新单个项目行的显示
        function refreshProjectRow(projectId) {
            fetch(`/api/jobs/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('获取项目信息失败:', data.error);
                        return;
                    }
                    
                    // 查找对应的表格行
                    const tbody = document.querySelector('.table tbody');
                    const existingRow = Array.from(tbody.children).find(row => {
                        const buttons = row.querySelectorAll('.dropdown-item');
                        return Array.from(buttons).some(button => {
                            const onclick = button.getAttribute('onclick');
                            return onclick && onclick.includes(projectId);
                        });
                    });

                    if (existingRow) {
                        const rowIndex = Array.from(tbody.children).indexOf(existingRow) + 1;
                        const newRowHtml = createTableRow(data.project, rowIndex);
                        
                        // 使用临时容器来创建DOM元素
                        const temp = document.createElement('tbody');
                        temp.innerHTML = newRowHtml;
                        const newRow = temp.firstElementChild;
                        
                        // 替换旧行
                        existingRow.replaceWith(newRow);
                        
                        // 为新行初始化下拉菜单
                        const dropdown = newRow.querySelector('.dropdown');
                        if (dropdown) {
                            initializeDropdownPosition(dropdown);
                        }

                        // 更新搜索功能的行引用
                        if (window.updateProjectSearchRows) {
                            window.updateProjectSearchRows();
                        }
                        
                        // 更新统计卡片
                        updateStatsCards();
                        
                        // 更新元器件总价格
                        if (typeof updateComponentsPrice === 'function') {
                            updateComponentsPrice();
                        }
                    }
                })
                .catch(error => {
                    console.error('刷新项目行失败:', error);
                });
}
</script>

</html>